var app=function(){"use strict";function t(){}function e(t){return t()}function a(){return Object.create(null)}function l(t){t.forEach(e)}function n(t){return"function"==typeof t}function s(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}let r,o;function i(t,e){return r||(r=document.createElement("a")),r.href=e,t===r.href}function d(t,e){t.appendChild(e)}function c(t,e,a){t.insertBefore(e,a||null)}function g(t){t.parentNode&&t.parentNode.removeChild(t)}function p(t){return document.createElement(t)}function u(t){return document.createTextNode(t)}function h(){return u(" ")}function y(){return u("")}function m(t,e,a,l){return t.addEventListener(e,a,l),()=>t.removeEventListener(e,a,l)}function f(t,e,a){null==a?t.removeAttribute(e):t.getAttribute(e)!==a&&t.setAttribute(e,a)}function x(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}function v(t,e){t.value=null==e?"":e}function b(t,e,a,l){null===a?t.style.removeProperty(e):t.style.setProperty(e,a,l?"important":"")}function $(t,e){for(let a=0;a<t.options.length;a+=1){const l=t.options[a];if(l.__value===e)return void(l.selected=!0)}t.selectedIndex=-1}function w(t,e,a){t.classList[a?"add":"remove"](e)}function k(t){o=t}function I(){if(!o)throw new Error("Function called outside component initialization");return o}function L(t){I().$$.on_mount.push(t)}function M(t){I().$$.after_update.push(t)}function A(){const t=I();return(e,a,{cancelable:l=!1}={})=>{const n=t.$$.callbacks[e];if(n){const s=function(t,e,{bubbles:a=!1,cancelable:l=!1}={}){const n=document.createEvent("CustomEvent");return n.initCustomEvent(t,a,l,e),n}(e,a,{cancelable:l});return n.slice().forEach(e=>{e.call(t,s)}),!s.defaultPrevented}return!0}}const E=[],R=[],C=[],S=[],_=Promise.resolve();let N=!1;function H(t){C.push(t)}const z=new Set;let P=0;function B(){if(0!==P)return;const t=o;do{try{for(;P<E.length;){const t=E[P];P++,k(t),O(t.$$)}}catch(t){throw E.length=0,P=0,t}for(k(null),E.length=0,P=0;R.length;)R.pop()();for(let t=0;t<C.length;t+=1){const e=C[t];z.has(e)||(z.add(e),e())}C.length=0}while(E.length);for(;S.length;)S.pop()();N=!1,z.clear(),k(t)}function O(t){if(null!==t.fragment){t.update(),l(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(H)}}const X=new Set;let G;function F(){G={r:0,c:[],p:G}}function T(){G.r||l(G.c),G=G.p}function q(t,e){t&&t.i&&(X.delete(t),t.i(e))}function j(t,e,a,l){if(t&&t.o){if(X.has(t))return;X.add(t),G.c.push(()=>{X.delete(t),l&&(a&&t.d(1),l())}),t.o(e)}else l&&l()}function V(t){t&&t.c()}function D(t,a,s,r){const{fragment:o,after_update:i}=t.$$;o&&o.m(a,s),r||H(()=>{const a=t.$$.on_mount.map(e).filter(n);t.$$.on_destroy?t.$$.on_destroy.push(...a):l(a),t.$$.on_mount=[]}),i.forEach(H)}function W(t,e){const a=t.$$;null!==a.fragment&&(l(a.on_destroy),a.fragment&&a.fragment.d(e),a.on_destroy=a.fragment=null,a.ctx=[])}function K(t,e){-1===t.$$.dirty[0]&&(E.push(t),N||(N=!0,_.then(B)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function Y(e,n,s,r,i,d,c,p=[-1]){const u=o;k(e);const h=e.$$={fragment:null,ctx:[],props:d,update:t,not_equal:i,bound:a(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(n.context||(u?u.$$.context:[])),callbacks:a(),dirty:p,skip_bound:!1,root:n.target||u.$$.root};c&&c(h.root);let y=!1;if(h.ctx=s?s(e,n.props||{},(t,a,...l)=>{const n=l.length?l[0]:a;return h.ctx&&i(h.ctx[t],h.ctx[t]=n)&&(!h.skip_bound&&h.bound[t]&&h.bound[t](n),y&&K(e,t)),a}):[],h.update(),y=!0,l(h.before_update),h.fragment=!!r&&r(h.ctx),n.target){if(n.hydrate){const t=function(t){return Array.from(t.childNodes)}(n.target);h.fragment&&h.fragment.l(t),t.forEach(g)}else h.fragment&&h.fragment.c();n.intro&&q(e.$$.fragment),D(e,n.target,n.anchor,n.customElement),B()}k(u)}class U{$destroy(){W(this,1),this.$destroy=t}$on(e,a){if(!n(a))return t;const l=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return l.push(a),()=>{const t=l.indexOf(a);-1!==t&&l.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const J=[];function Q(e,a=t){let l;const n=new Set;function r(t){if(s(e,t)&&(e=t,l)){const t=!J.length;for(const t of n)t[1](),J.push(t,e);if(t){for(let t=0;t<J.length;t+=2)J[t][0](J[t+1]);J.length=0}}}return{set:r,update:function(t){r(t(e))},subscribe:function(s,o=t){const i=[s,o];return n.add(i),1===n.size&&(l=a(r)||t),s(e),()=>{n.delete(i),0===n.size&&(l(),l=null)}}}}const Z=Q([]),tt=Q(void 0),et=Q(void 0),at=Q(void 0),lt=Q([]),nt=Q(void 0),st=Q({}),rt=Q([]),ot=Q([void 0,void 0]),it=Q(!0),dt=Q(!1),ct=Q(!1),gt=Q({}),pt=Q(!1),ut=Q({}),ht=Q({}),yt=Q({}),mt=(t,e,a)=>{let l=[];for(let n=0;n<t;n++){let t=new Array(e).fill(a);l.push(t)}return l},ft=(t,e)=>{console.assert(t.length===e.length,"Dimension not matching"),console.assert(t[0].length===e[0].length,"Dimension not matching");let a=0;for(let l=0;l<t.length;l++)for(let n=0;n<t[0].length;n++)a+=t[l][n]*e[l][n];return a},xt=(t,e,a,l,n)=>t.slice(e,a).map(t=>t.slice(l,n)),vt=t=>{let e=-1/0;for(let a=0;a<t.length;a++)for(let l=0;l<t[0].length;l++)t[a][l]>e&&(e=t[a][l]);return e},bt=(t,e,a=1,l=0)=>{console.assert(t.length===t[0].length,"Conv input is not square"),console.assert(e.length===e[0].length,"Conv kernel is not square");let n=(t.length-e.length)/a+1,s=mt(n,n,0);for(let l=0;l<n;l++)for(let r=0;r<n;r++){let n=xt(t,l*a,l*a+e.length,r*a,r*a+e.length),o=ft(n,e);s[l][r]=o}return s},$t=(t,e=2,a=2,l="VALID")=>{console.assert(2===e,"Only supports kernen = [2,2]"),console.assert(2===a,"Only supports stride = 2"),console.assert("VALID"===l,"Only support valid padding"),t.length%2==1&&"VALID"===l&&(t=xt(t,0,t.length-1,0,t.length-1));let n=(t.length-e)/a+1,s=mt(n,n,0);for(let l=0;l<n;l++)for(let r=0;r<n;r++){let n=xt(t,l*a,l*a+e,r*a,r*a+e);s[l][r]=vt(n)}return s};function wt(t,e){return Array.from({length:t},e?(t,a)=>e(a):void 0)}function kt(t,e,a){return Array.from({length:t},(t,l)=>Array.from({length:e},a?(t,e)=>a(l,e):void 0))}function It(t,e,a,l,n){const s=kt(e.length,e.length,(t,e)=>kt(a,a));for(let r=0;r<e.length;r++)for(let o=0;o<e.length;o++)for(let e=0;e<a;e++)for(let i=0;i<a;i++){const a=r*t+e*n,d=o*t+i*n;s[r][o][e][i]=a*l+d}return s}function Lt(t,e,a,l,n,s){const r=wt(a*a);for(let a=0;a<s;a++)for(let l=0;l<s;l++){const s=n[t][e][a][l];void 0!==s&&(r[s]=[a,l])}return r}function Mt(t,e,a){var l=e.reduce((t,e,a)=>(null!=e&&t.push(a),t),[]);return xt(t,Math.floor(l[0]/t.length),Math.floor(l[0]/t.length)+a,l[0]%t.length,l[0]%t.length+a)}function At(t,e){var a=e.reduce((t,e,a)=>(0!=e&&t.push(a),t),[]);return xt(t,Math.floor(a[0]/t.length),Math.floor(a[0]/t.length)+1,a[0]%t.length,a[0]%t.length+1)}function Et(t){return 150/t>20?20:150/t}function Rt(t){let e=t.map((function(t){return Math.max.apply(Math,t)})),a=Math.max.apply(null,e),l=t.map((function(t){return Math.min.apply(Math,t)})),n=Math.min.apply(null,l);return{range:2*Math.max(Math.abs(n),Math.abs(a)),min:n,max:a}}function Ct(t,e=Et(t.length)){for(var a=new Array,l=1,n=1,s=e,r=e,o=0;o<t.length;o++){a.push(new Array);for(var i=0;i<t[0].length;i++)a[o].push({text:Math.round(100*t[o][i])/100,row:o,col:i,x:l,y:n,width:s,height:r}),l+=s;l=1,n+=r}return a}function St(e){let a;return{c(){a=p("div"),a.innerHTML='<svg id="grid" width="100%" height="100%"></svg>',b(a,"display","inline-block"),b(a,"vertical-align","middle"),f(a,"class","grid")},m(t,l){c(t,a,l),e[10](a)},p:t,i:t,o:t,d(t){t&&g(a),e[10](null)}}}function _t(t,e,a){let l,{data:n}=e,{highlights:s}=e,{isKernelMath:r}=e,{constraint:o}=e,{dataRange:i}=e,{outputLength:d}=e,{stride:c}=e,{colorScale:g=d3.interpolateRdBu}=e,{isInputLayer:p=!1}=e;const u=A();let h=s,y=n;const m=()=>{d3.select(l).selectAll("#grid > *").remove();const t=n.length*o+2;var e=d3.select(l).select("#grid").attr("width",t+"px").attr("height",t+"px").append("svg").attr("width",t+"px").attr("height",t+"px").selectAll(".row").data(n).enter().append("g").attr("class","row");e.selectAll(".square").data((function(t){return t})).enter().append("rect").attr("class","square").attr("x",(function(t){return t.x})).attr("y",(function(t){return t.y})).attr("width",(function(t){return t.width})).attr("height",(function(t){return t.height})).style("opacity",.8).style("fill",(function(t){let e=t.text;return e=p?1-t.text:(t.text+i/2)/i,g(e)})).on("mouseover",(function(t){n.length!=d?u("message",{hoverH:Math.min(Math.floor(t.row/c),d-1),hoverW:Math.min(Math.floor(t.col/c),d-1)}):u("message",{hoverH:Math.min(Math.floor(t.row/1),d-1),hoverW:Math.min(Math.floor(t.col/1),d-1)})}));if(r)e.selectAll(".text").data((function(t){return t})).enter().append("text").attr("class","text").style("font-size",Math.floor(o/2.6)+"px").attr("x",(function(t){return t.x+t.width/2})).attr("y",(function(t){return t.y+t.height/2})).style("fill",(function(t){let e=t.text;return e=p?1-t.text:(t.text+i/2)/i,e<.2||e>.8?"white":"black"})).style("text-anchor","middle").style("dominant-baseline","middle").text((function(t){return t.text.toString().replace("-","－")}))};return M(()=>{(n!=y&&(m(),y=n),s!=h)&&(d3.select(l).select("#grid").select("svg").selectAll(".square").style("stroke",t=>r||s.length&&s[t.row*n.length+t.col]?"black":null),h=s)}),L(()=>{m()}),t.$$set=t=>{"data"in t&&a(1,n=t.data),"highlights"in t&&a(2,s=t.highlights),"isKernelMath"in t&&a(3,r=t.isKernelMath),"constraint"in t&&a(4,o=t.constraint),"dataRange"in t&&a(5,i=t.dataRange),"outputLength"in t&&a(6,d=t.outputLength),"stride"in t&&a(7,c=t.stride),"colorScale"in t&&a(8,g=t.colorScale),"isInputLayer"in t&&a(9,p=t.isInputLayer)},[l,n,s,r,o,i,d,c,g,p,function(t){R[t?"unshift":"push"](()=>{l=t,a(0,l)})}]}class Nt extends U{constructor(t){super(),Y(this,t,_t,St,s,{data:1,highlights:2,isKernelMath:3,constraint:4,dataRange:5,outputLength:6,stride:7,colorScale:8,isInputLayer:9})}}function Ht(e){let a,l,n;return{c(){a=p("div"),l=h(),n=p("div"),n.innerHTML='<svg id="grid" width="100%" height="100%"></svg>',f(a,"class","legend"),f(n,"class","grid")},m(t,s){c(t,a,s),e[10](a),c(t,l,s),c(t,n,s),e[11](n)},p:t,i:t,o:t,d(t){t&&g(a),e[10](null),t&&g(l),t&&g(n),e[11](null)}}}function zt(t,e,a){let l,n,{data:s}=e,{kernel:r}=e,{constraint:o}=e,{dataRange:i}=e,{kernelRange:d}=e,{colorScale:c=d3.interpolateRdBu}=e,{kernelColorScale:g=d3.interpolateBrBG}=e,{isInputLayer:p=!1}=e;const u=Math.floor(o/3);let h=s;const y=()=>{d3.select(l).selectAll("#grid > *").remove();const t=r?s.length*o*2+2:s.length*o+2;var e=d3.select(l).select("#grid").attr("width",t+"px").attr("height",t+"px").append("svg").attr("width",t+"px").attr("height",t+"px").selectAll(".row").data(s).enter().append("g").attr("class","row"),a=e.selectAll(".square").data((function(t){return t})).enter();a.append("rect").attr("class","square").attr("x",(function(t){return 1===t.x?t.x+u:2*t.x+u})).attr("y",(function(t){return 1===t.y?t.y:2*t.y})).attr("width",(function(t){return t.width})).attr("height",(function(t){return t.height})).style("opacity",.5).style("fill",(function(t){let e=t.text;return e=p?1-t.text:(t.text+i/2)/i,c(e)})).style("stroke","black"),a.append("rect").attr("class","square").attr("x",(function(t){return 1===t.x?t.x+u:2*t.x+u})).attr("y",(function(t){return 1===t.y?t.y+t.height:2*t.y+t.height})).attr("width",(function(t){return t.width})).attr("height",(function(t){return t.height/2})).style("opacity",.5).style("fill",(function(t){let e=(r[t.row][t.col].text+d.range/2)/d.range;return g(.6*e+.2)}));var n=e.selectAll(".text").data((function(t){return t})).enter();n.append("text").attr("class","text").style("font-size",Math.floor(o/2.6)+"px").attr("x",(function(t){return 1===t.x?t.x+t.width/2+u:2*t.x+t.width/2+u})).attr("y",(function(t){return 1===t.y?t.y+t.height/2:2*t.y+t.height/2})).style("fill",(function(t){let e=t.text;return e=p?1-t.text:(t.text+i/2)/i,e<.2||e>.8?p&&e<.2?"black":"white":"black"})).style("text-anchor","middle").style("dominant-baseline","middle").text((function(t){return t.text})),n.append("text").attr("class","text").style("font-size",Math.floor(o/2.6)+"px").attr("font-weight",600).attr("x",(function(t){return 1===t.x?t.x+u/2:2*t.x+u/2})).attr("y",(function(t){return 1===t.y?t.y+t.height+t.height/4:2*t.y+t.height+t.height/4})).style("fill","black").style("text-anchor","middle").style("dominant-baseline","middle").text((function(t){return"×"})),n.append("text").attr("class","text").style("font-size",Math.floor(o/2.6)+"px").attr("x",(function(t){return 1===t.x?t.x+t.width/2+u:2*t.x+t.width/2+u})).attr("y",(function(t){return 1===t.y?t.y+t.height+t.height/4:2*t.y+t.height+t.height/4})).style("fill",(function(t){let e=.6*((r[t.row][t.col].text+d.range/2)/d.range)+.2;return e<.2||e>.8?"white":"black"})).style("text-anchor","middle").style("dominant-baseline","middle").text((function(t){return r[t.row][t.col].text})),n.append("text").attr("class","text").style("font-size",Math.floor(o/1.6)+"px").attr("x",(function(t){return 1===t.x?t.x+t.width+t.width/2+u:2*t.x+t.width+t.width/2+u})).attr("y",(function(t){return 1===t.y?t.y+t.height/2:2*t.y+t.height/2})).style("text-anchor","middle").style("dominant-baseline","middle").text((function(t){return t.row==r.length-1&&t.col==r.length-1?"=":"+"}))};return M(()=>{s!=h&&(y(),h=s)}),L(()=>{y()}),t.$$set=t=>{"data"in t&&a(2,s=t.data),"kernel"in t&&a(3,r=t.kernel),"constraint"in t&&a(4,o=t.constraint),"dataRange"in t&&a(5,i=t.dataRange),"kernelRange"in t&&a(6,d=t.kernelRange),"colorScale"in t&&a(7,c=t.colorScale),"kernelColorScale"in t&&a(8,g=t.kernelColorScale),"isInputLayer"in t&&a(9,p=t.isInputLayer)},[l,n,s,r,o,i,d,c,g,p,function(t){R[t?"unshift":"push"](()=>{n=t,a(1,n)})},function(t){R[t?"unshift":"push"](()=>{l=t,a(0,l)})}]}class Pt extends U{constructor(t){super(),Y(this,t,zt,Ht,s,{data:2,kernel:3,constraint:4,dataRange:5,kernelRange:6,colorScale:7,kernelColorScale:8,isInputLayer:9})}}function Bt(t){let e,a,l,n,s,r,o,i,y,m,v,b,$,w,k,I,L,M,A,E,R,C,S,_,N,H=t[2].length+"",z=t[2][0].length+"",P=t[3].length+"",B=t[3][0].length+"";return y=new Nt({props:{data:t[11],highlights:t[7],outputLength:t[3].length,isKernelMath:!1,constraint:Et(t[2].length),dataRange:t[4],stride:t[0],colorScale:t[5],isInputLayer:t[6]}}),y.$on("message",t[14]),b=new Pt({props:{data:t[9],kernel:t[13],constraint:Et(t[1].length),dataRange:t[4],kernelRange:Rt(t[1]),colorScale:t[5],isInputLayer:t[6]}}),w=new Nt({props:{data:t[10],highlights:t[8],isKernelMath:!0,constraint:Et(t[1].length),dataRange:t[4]}}),_=new Nt({props:{data:t[12],highlights:t[8],isKernelMath:!1,outputLength:t[3].length,constraint:Et(t[3].length),dataRange:t[4],stride:t[0]}}),_.$on("message",t[14]),{c(){e=p("div"),a=p("div"),l=u("Input ("),n=u(H),s=u(", "),r=u(z),o=u(")"),i=h(),V(y.$$.fragment),m=h(),v=p("div"),V(b.$$.fragment),$=h(),V(w.$$.fragment),k=h(),I=p("div"),L=p("div"),M=u("Output ("),A=u(P),E=u(", "),R=u(B),C=u(")"),S=h(),V(_.$$.fragment),f(a,"class","header-text"),f(e,"class","column has-text-centered svelte-gz7a6i"),f(v,"class","column has-text-centered svelte-gz7a6i"),f(L,"class","header-text"),f(I,"class","column has-text-centered svelte-gz7a6i")},m(t,g){c(t,e,g),d(e,a),d(a,l),d(a,n),d(a,s),d(a,r),d(a,o),d(e,i),D(y,e,null),c(t,m,g),c(t,v,g),D(b,v,null),d(v,$),D(w,v,null),c(t,k,g),c(t,I,g),d(I,L),d(L,M),d(L,A),d(L,E),d(L,R),d(L,C),d(I,S),D(_,I,null),N=!0},p(t,[e]){(!N||4&e)&&H!==(H=t[2].length+"")&&x(n,H),(!N||4&e)&&z!==(z=t[2][0].length+"")&&x(r,z);const a={};2048&e&&(a.data=t[11]),128&e&&(a.highlights=t[7]),8&e&&(a.outputLength=t[3].length),4&e&&(a.constraint=Et(t[2].length)),16&e&&(a.dataRange=t[4]),1&e&&(a.stride=t[0]),32&e&&(a.colorScale=t[5]),64&e&&(a.isInputLayer=t[6]),y.$set(a);const l={};512&e&&(l.data=t[9]),8192&e&&(l.kernel=t[13]),2&e&&(l.constraint=Et(t[1].length)),16&e&&(l.dataRange=t[4]),2&e&&(l.kernelRange=Rt(t[1])),32&e&&(l.colorScale=t[5]),64&e&&(l.isInputLayer=t[6]),b.$set(l);const s={};1024&e&&(s.data=t[10]),256&e&&(s.highlights=t[8]),2&e&&(s.constraint=Et(t[1].length)),16&e&&(s.dataRange=t[4]),w.$set(s),(!N||8&e)&&P!==(P=t[3].length+"")&&x(A,P),(!N||8&e)&&B!==(B=t[3][0].length+"")&&x(R,B);const o={};4096&e&&(o.data=t[12]),256&e&&(o.highlights=t[8]),8&e&&(o.outputLength=t[3].length),8&e&&(o.constraint=Et(t[3].length)),16&e&&(o.dataRange=t[4]),1&e&&(o.stride=t[0]),_.$set(o)},i(t){N||(q(y.$$.fragment,t),q(b.$$.fragment,t),q(w.$$.fragment,t),q(_.$$.fragment,t),N=!0)},o(t){j(y.$$.fragment,t),j(b.$$.fragment,t),j(w.$$.fragment,t),j(_.$$.fragment,t),N=!1},d(t){t&&g(e),W(y),t&&g(m),t&&g(v),W(b),W(w),t&&g(k),t&&g(I),W(_)}}}function Ot(t,e,a){let{stride:l}=e,{dilation:n}=e,{kernel:s}=e,{image:r}=e,{output:o}=e,{isPaused:i}=e,{dataRange:d}=e,{colorScale:c}=e,{isInputInputLayer:g=!1}=e;const p=A();let u=r.length+0,h=[];for(let t=0;t<s.length;t++){h.push([]);for(let e=0;e<s.length;e++)h[t].push(0)}h=Ct(h);let y,m,f=Ct([0]),x=[],v=wt(o.length*o.length,t=>!0);function b(t){m=0;let e=It(t,o,s.length,u,n);t<=0||(y&&clearInterval(y),a(17,y=setInterval(()=>{if(i)return;const t=m%(o.length*o.length);a(8,v=wt(o.length*o.length,t=>!1));const l=Math.floor(t/o.length),n=t%o.length;a(8,v[l*o.length+n]=!0,v),a(7,x=Lt(l,n,u,s.length,e,s.length));const d=Mt(r,x,s.length);a(9,h=Ct(d));const c=At(o,v);a(10,f=Ct(c)),m++},250)))}b(l);let $=Ct(r),w=Ct(o),k=Ct(s);return t.$$set=t=>{"stride"in t&&a(0,l=t.stride),"dilation"in t&&a(16,n=t.dilation),"kernel"in t&&a(1,s=t.kernel),"image"in t&&a(2,r=t.image),"output"in t&&a(3,o=t.output),"isPaused"in t&&a(15,i=t.isPaused),"dataRange"in t&&a(4,d=t.dataRange),"colorScale"in t&&a(5,c=t.colorScale),"isInputInputLayer"in t&&a(6,g=t.isInputInputLayer)},t.$$.update=()=>{if(4&t.$$.dirty&&(u=r.length+0),8&t.$$.dirty){wt(o.length*o.length,t=>!0)}15&t.$$.dirty&&(b(l),a(11,$=Ct(r)),a(12,w=Ct(o)),a(13,k=Ct(s)))},[l,s,r,o,d,c,g,x,v,h,f,$,w,k,function(t){let e=It(l,o,s.length,u,n);a(8,v=wt(o.length*o.length,t=>!1));const d=t.detail.hoverH,c=t.detail.hoverW;a(8,v[d*o.length+c]=!0,v),a(7,x=Lt(d,c,u,s.length,e,s.length));const g=Mt(r,x,s.length);a(9,h=Ct(g));const y=At(o,v);a(10,f=Ct(y)),a(15,i=!0),p("message",{text:i})},i,n,y]}class Xt extends U{constructor(t){super(),Y(this,t,Ot,Bt,s,{stride:0,dilation:16,kernel:1,image:2,output:3,isPaused:15,dataRange:4,colorScale:5,isInputInputLayer:6})}}function Gt(t){let e,a,n,s,r,o,i,u,y,x,v,b,$,w,k,I,L,M,A,E=t[6]?'<i class="fas fa-play-circle play-icon"></i>':'<i class="fas fa-pause-circle"></i>';return w=new Xt({props:{kernel:t[2],image:t[1],output:t[7],stride:Tt,dilation:qt,isPaused:t[6],dataRange:t[3],colorScale:t[4],isInputInputLayer:t[5]}}),w.$on("message",t[9]),{c(){e=p("div"),a=p("div"),n=p("div"),s=p("div"),s.textContent="Convolution",r=h(),o=p("div"),i=p("div"),i.innerHTML='<i class="fas fa-info-circle"></i>',u=h(),y=p("div"),x=h(),v=p("div"),v.innerHTML='<i class="fas control-icon fa-times-circle"></i>',b=h(),$=p("div"),V(w.$$.fragment),k=h(),I=p("div"),I.innerHTML='<img src="/cnn-vis/assets/img/pointer.svg" alt="pointer icon" class="svelte-1j8mhv0"/> \n        <div class="annotation-text"><span style="font-weight:600">Hover over</span> the matrices to change kernel position.</div>',f(s,"class","title-text svelte-1j8mhv0"),f(i,"class","control-button svelte-1j8mhv0"),f(i,"title","Jump to article section"),f(y,"class","play-button control-button svelte-1j8mhv0"),f(y,"title","Play animation"),f(v,"class","delete-button control-button svelte-1j8mhv0"),f(v,"title","Close"),f(o,"class","buttons svelte-1j8mhv0"),f(n,"class","control-pannel svelte-1j8mhv0"),f($,"class","container is-centered svelte-1j8mhv0"),f(I,"class","annotation svelte-1j8mhv0"),f(a,"class","box svelte-1j8mhv0"),f(e,"class","container svelte-1j8mhv0"),f(e,"id","detailview-container")},m(l,g){c(l,e,g),d(e,a),d(a,n),d(n,s),d(n,r),d(n,o),d(o,i),d(o,u),d(o,y),y.innerHTML=E,d(o,x),d(o,v),d(a,b),d(a,$),D(w,$,null),d(a,k),d(a,I),L=!0,M||(A=[m(i,"click",jt),m(y,"click",t[8]),m(v,"click",t[10])],M=!0)},p(t,e){(!L||64&e)&&E!==(E=t[6]?'<i class="fas fa-play-circle play-icon"></i>':'<i class="fas fa-pause-circle"></i>')&&(y.innerHTML=E);const a={};4&e&&(a.kernel=t[2]),2&e&&(a.image=t[1]),128&e&&(a.output=t[7]),64&e&&(a.isPaused=t[6]),8&e&&(a.dataRange=t[3]),16&e&&(a.colorScale=t[4]),32&e&&(a.isInputInputLayer=t[5]),w.$set(a)},i(t){L||(q(w.$$.fragment,t),L=!0)},o(t){j(w.$$.fragment,t),L=!1},d(t){t&&g(e),W(w),M=!1,l(A)}}}function Ft(t){let e,a,l=!t[0]&&Gt(t);return{c(){l&&l.c(),e=y()},m(t,n){l&&l.m(t,n),c(t,e,n),a=!0},p(t,[a]){t[0]?l&&(F(),j(l,1,1,()=>{l=null}),T()):l?(l.p(t,a),1&a&&q(l,1)):(l=Gt(t),l.c(),q(l,1),l.m(e.parentNode,e))},i(t){a||(q(l),a=!0)},o(t){j(l),a=!1},d(t){l&&l.d(t),t&&g(e)}}}let Tt=1;const qt=1;function jt(){let t=Number(d3.select("#cnn-svg").style("height").replace("px",""))+150,e=new SmoothScroll('a[href*="#"]',{offset:-t}),a=document.querySelector("#article-convolution");e.animateScroll(a)}function Vt(t,e,a){let{input:l}=e,{kernel:n}=e,{dataRange:s}=e,{colorScale:r=d3.interpolateRdBu}=e,{isInputInputLayer:o=!1}=e,{isExited:i=!1}=e;const d=A();var c=!1,g=bt(l,n,Tt);return t.$$set=t=>{"input"in t&&a(1,l=t.input),"kernel"in t&&a(2,n=t.kernel),"dataRange"in t&&a(3,s=t.dataRange),"colorScale"in t&&a(4,r=t.colorScale),"isInputInputLayer"in t&&a(5,o=t.isInputInputLayer),"isExited"in t&&a(0,i=t.isExited)},t.$$.update=()=>{if(6&t.$$.dirty)try{a(7,g=bt(l,n,Tt))}catch{console.log("Cannot handle stride of "+Tt)}},[i,l,n,s,r,o,c,g,function(){a(6,c=!c)},function(t){a(6,c=t.detail.text)},function(){a(0,i=!0),d("message",{text:i})}]}class Dt extends U{constructor(t){super(),Y(this,t,Vt,Ft,s,{input:1,kernel:2,dataRange:3,colorScale:4,isInputInputLayer:5,isExited:0})}}function Wt(t){let e,a,l,n,s,r,o,i,y,m,v,b,$,w,k,I,L,M,A,E,R,C,S,_,N,H,z,P,B,O=t[0].length+"",X=t[0][0].length+"",G=t[1].length+"",F=t[1][0].length+"";return y=new Nt({props:{data:t[7],highlights:t[3],outputLength:t[1].length,isKernelMath:!1,constraint:Et(t[0].length),dataRange:t[2],stride:1}}),y.$on("message",t[9]),w=new Nt({props:{data:Ct([[0]]),highlights:t[4],isKernelMath:!0,constraint:20,dataRange:t[2]}}),I=new Nt({props:{data:t[5],highlights:t[4],isKernelMath:!0,constraint:20,dataRange:t[2]}}),M=new Nt({props:{data:t[6],highlights:t[4],isKernelMath:!0,constraint:20,dataRange:t[2]}}),P=new Nt({props:{data:t[8],highlights:t[4],isKernelMath:!1,outputLength:t[1].length,constraint:Et(t[1].length),dataRange:t[2],stride:1}}),P.$on("message",t[9]),{c(){e=p("div"),a=p("div"),l=u("Input ("),n=u(O),s=u(", "),r=u(X),o=u(")"),i=h(),V(y.$$.fragment),m=h(),v=p("div"),b=p("span"),$=u("max(\n    "),V(w.$$.fragment),k=u("\n    ,\n    "),V(I.$$.fragment),L=u("\n    )\n    =\n    "),V(M.$$.fragment),A=h(),E=p("div"),R=p("div"),C=u("Output ("),S=u(G),_=u(", "),N=u(F),H=u(")"),z=h(),V(P.$$.fragment),f(a,"class","header-text"),f(e,"class","column has-text-centered svelte-gz7a6i"),f(v,"class","column has-text-centered svelte-gz7a6i"),f(R,"class","header-text"),f(E,"class","column has-text-centered svelte-gz7a6i")},m(t,g){c(t,e,g),d(e,a),d(a,l),d(a,n),d(a,s),d(a,r),d(a,o),d(e,i),D(y,e,null),c(t,m,g),c(t,v,g),d(v,b),d(b,$),D(w,b,null),d(b,k),D(I,b,null),d(b,L),D(M,b,null),c(t,A,g),c(t,E,g),d(E,R),d(R,C),d(R,S),d(R,_),d(R,N),d(R,H),d(E,z),D(P,E,null),B=!0},p(t,[e]){(!B||1&e)&&O!==(O=t[0].length+"")&&x(n,O),(!B||1&e)&&X!==(X=t[0][0].length+"")&&x(r,X);const a={};128&e&&(a.data=t[7]),8&e&&(a.highlights=t[3]),2&e&&(a.outputLength=t[1].length),1&e&&(a.constraint=Et(t[0].length)),4&e&&(a.dataRange=t[2]),y.$set(a);const l={};16&e&&(l.highlights=t[4]),4&e&&(l.dataRange=t[2]),w.$set(l);const s={};32&e&&(s.data=t[5]),16&e&&(s.highlights=t[4]),4&e&&(s.dataRange=t[2]),I.$set(s);const o={};64&e&&(o.data=t[6]),16&e&&(o.highlights=t[4]),4&e&&(o.dataRange=t[2]),M.$set(o),(!B||2&e)&&G!==(G=t[1].length+"")&&x(S,G),(!B||2&e)&&F!==(F=t[1][0].length+"")&&x(N,F);const i={};256&e&&(i.data=t[8]),16&e&&(i.highlights=t[4]),2&e&&(i.outputLength=t[1].length),2&e&&(i.constraint=Et(t[1].length)),4&e&&(i.dataRange=t[2]),P.$set(i)},i(t){B||(q(y.$$.fragment,t),q(w.$$.fragment,t),q(I.$$.fragment,t),q(M.$$.fragment,t),q(P.$$.fragment,t),B=!0)},o(t){j(y.$$.fragment,t),j(w.$$.fragment,t),j(I.$$.fragment,t),j(M.$$.fragment,t),j(P.$$.fragment,t),B=!1},d(t){t&&g(e),W(y),t&&g(m),t&&g(v),W(w),W(I),W(M),t&&g(A),t&&g(E),W(P)}}}function Kt(t,e,a){let{image:l}=e,{output:n}=e,{isPaused:s}=e,{dataRange:r}=e;const o=A();let i,d,c=l.length+0,g=Ct([[0]]),p=Ct([[0]]),u=wt(l.length*l.length,t=>!0),h=wt(n.length*n.length,t=>!0);function y(){d=0,i&&clearInterval(i),a(11,i=setInterval(()=>{if(s)return;const t=d%(n.length*n.length);a(4,h=wt(n.length*n.length,t=>!1)),a(3,u=wt(l.length*l.length,t=>{}));const e=Math.floor(t/n.length),r=t%n.length;a(4,h[e*n.length+r]=!0,h),a(3,u[e*n.length+r]=!0,u);const o=Mt(l,u,1);a(5,g=Ct(o));const i=At(n,h);a(6,p=Ct(i)),d++},250))}y();let m=Ct(l),f=Ct(n);return t.$$set=t=>{"image"in t&&a(0,l=t.image),"output"in t&&a(1,n=t.output),"isPaused"in t&&a(10,s=t.isPaused),"dataRange"in t&&a(2,r=t.dataRange)},t.$$.update=()=>{if(1&t.$$.dirty&&(c=l.length+0),3&t.$$.dirty){wt(l.length*l.length,t=>!0),wt(n.length*n.length,t=>!0)}3&t.$$.dirty&&(y(),a(7,m=Ct(l)),a(8,f=Ct(n)))},[l,n,r,u,h,g,p,m,f,function(t){a(4,h=wt(n.length*n.length,t=>!1));const e=t.detail.hoverH,r=t.detail.hoverW;a(4,h[e*n.length+r]=!0,h),a(3,u=wt(l.length*l.length,t=>{})),a(3,u[e*n.length+r]=!0,u);const i=Mt(l,u,1);a(5,g=Ct(i));const d=At(n,h);a(6,p=Ct(d)),a(10,s=!0),o("message",{text:s})},s,i]}class Yt extends U{constructor(t){super(),Y(this,t,Kt,Wt,s,{image:0,output:1,isPaused:10,dataRange:2})}}function Ut(t){let e,a,n,s,r,o,i,u,y,x,v,b,$,w,k,I,L,M,A,E=t[4]?'<i class="fas fa-play-circle play-icon"></i>':'<i class="fas fa-pause-circle"></i>';return w=new Yt({props:{image:t[0],output:t[1],isPaused:t[4],dataRange:t[2]}}),w.$on("message",t[6]),{c(){e=p("div"),a=p("div"),n=p("div"),s=p("div"),s.textContent="ReLU Activation",r=h(),o=p("div"),i=p("div"),i.innerHTML='<i class="fas fa-info-circle"></i>',u=h(),y=p("div"),x=h(),v=p("div"),v.innerHTML='<i class="fas control-icon fa-times-circle"></i>',b=h(),$=p("div"),V(w.$$.fragment),k=h(),I=p("div"),I.innerHTML='<img src="/cnn-vis/assets/img/pointer.svg" alt="pointer icon" class="svelte-1lq7956"/> \n        <div class="annotation-text"><span style="font-weight:600">Hover over</span> the matrices to change pixel.</div>',f(s,"class","title-text svelte-1lq7956"),f(i,"class","control-button svelte-1lq7956"),f(i,"title","Jump to article section"),f(y,"class","play-button control-button svelte-1lq7956"),f(y,"title","Play animation"),f(v,"class","delete-button control-button svelte-1lq7956"),f(v,"title","Close"),f(o,"class","buttons svelte-1lq7956"),f(n,"class","control-pannel svelte-1lq7956"),f($,"class","container is-centered is-vcentered svelte-1lq7956"),f(I,"class","annotation svelte-1lq7956"),f(a,"class","box svelte-1lq7956"),f(e,"class","container svelte-1lq7956")},m(l,g){c(l,e,g),d(e,a),d(a,n),d(n,s),d(n,r),d(n,o),d(o,i),d(o,u),d(o,y),y.innerHTML=E,d(o,x),d(o,v),d(a,b),d(a,$),D(w,$,null),d(a,k),d(a,I),L=!0,M||(A=[m(i,"click",Qt),m(y,"click",t[5]),m(v,"click",t[7])],M=!0)},p(t,e){(!L||16&e)&&E!==(E=t[4]?'<i class="fas fa-play-circle play-icon"></i>':'<i class="fas fa-pause-circle"></i>')&&(y.innerHTML=E);const a={};1&e&&(a.image=t[0]),2&e&&(a.output=t[1]),16&e&&(a.isPaused=t[4]),4&e&&(a.dataRange=t[2]),w.$set(a)},i(t){L||(q(w.$$.fragment,t),L=!0)},o(t){j(w.$$.fragment,t),L=!1},d(t){t&&g(e),W(w),M=!1,l(A)}}}function Jt(t){let e,a,l=!t[3]&&Ut(t);return{c(){l&&l.c(),e=y()},m(t,n){l&&l.m(t,n),c(t,e,n),a=!0},p(t,[a]){t[3]?l&&(F(),j(l,1,1,()=>{l=null}),T()):l?(l.p(t,a),8&a&&q(l,1)):(l=Ut(t),l.c(),q(l,1),l.m(e.parentNode,e))},i(t){a||(q(l),a=!0)},o(t){j(l),a=!1},d(t){l&&l.d(t),t&&g(e)}}}function Qt(){let t=Number(d3.select("#cnn-svg").style("height").replace("px",""))+150,e=new SmoothScroll('a[href*="#"]',{offset:-t}),a=document.querySelector("#article-relu");e.animateScroll(a)}function Zt(t,e,a){let{input:l}=e,{output:n}=e,{dataRange:s}=e,{isExited:r}=e;const o=A();let i=!1;return t.$$set=t=>{"input"in t&&a(0,l=t.input),"output"in t&&a(1,n=t.output),"dataRange"in t&&a(2,s=t.dataRange),"isExited"in t&&a(3,r=t.isExited)},[l,n,s,r,i,function(){a(4,i=!i)},function(t){a(4,i=t.detail.text)},function(){o("message",{text:!0})}]}class te extends U{constructor(t){super(),Y(this,t,Zt,Jt,s,{input:0,output:1,dataRange:2,isExited:3})}}function ee(t){let e,a,l,n,s,r,o,i,y,m,v,b,$,w,k,I,L,M,A,E,R,C,S,_,N,H,z,P=t[9].length+"",B=t[9][0].length+"",O=t[10].length+"",X=t[10][0].length+"";return y=new Nt({props:{data:t[9],highlights:t[5],outputLength:t[3].length,isKernelMath:!1,constraint:Et(t[2].length),dataRange:t[4],stride:t[0]}}),y.$on("message",t[11]),w=new Nt({props:{data:t[7],highlights:t[6],isKernelMath:!0,constraint:Et(t[1]),dataRange:t[4]}}),I=new Nt({props:{data:t[8],highlights:t[6],isKernelMath:!0,constraint:Et(t[1]),dataRange:t[4]}}),H=new Nt({props:{data:t[10],highlights:t[6],isKernelMath:!1,outputLength:t[3].length,constraint:Et(t[3].length),dataRange:t[4],stride:t[0]}}),H.$on("message",t[11]),{c(){e=p("div"),a=p("div"),l=u("Input ("),n=u(P),s=u(", "),r=u(B),o=u(")"),i=h(),V(y.$$.fragment),m=h(),v=p("div"),b=p("span"),$=u("max(\n    "),V(w.$$.fragment),k=u("\n    )\n    =\n    "),V(I.$$.fragment),L=h(),M=p("div"),A=p("div"),E=u("Output ("),R=u(O),C=u(", "),S=u(X),_=u(")"),N=h(),V(H.$$.fragment),f(a,"class","header-text"),f(e,"class","column has-text-centered svelte-gz7a6i"),f(v,"class","column has-text-centered svelte-gz7a6i"),f(A,"class","header-text"),f(M,"class","column has-text-centered svelte-gz7a6i")},m(t,g){c(t,e,g),d(e,a),d(a,l),d(a,n),d(a,s),d(a,r),d(a,o),d(e,i),D(y,e,null),c(t,m,g),c(t,v,g),d(v,b),d(b,$),D(w,b,null),d(b,k),D(I,b,null),c(t,L,g),c(t,M,g),d(M,A),d(A,E),d(A,R),d(A,C),d(A,S),d(A,_),d(M,N),D(H,M,null),z=!0},p(t,[e]){(!z||512&e)&&P!==(P=t[9].length+"")&&x(n,P),(!z||512&e)&&B!==(B=t[9][0].length+"")&&x(r,B);const a={};512&e&&(a.data=t[9]),32&e&&(a.highlights=t[5]),8&e&&(a.outputLength=t[3].length),4&e&&(a.constraint=Et(t[2].length)),16&e&&(a.dataRange=t[4]),1&e&&(a.stride=t[0]),y.$set(a);const l={};128&e&&(l.data=t[7]),64&e&&(l.highlights=t[6]),2&e&&(l.constraint=Et(t[1])),16&e&&(l.dataRange=t[4]),w.$set(l);const s={};256&e&&(s.data=t[8]),64&e&&(s.highlights=t[6]),2&e&&(s.constraint=Et(t[1])),16&e&&(s.dataRange=t[4]),I.$set(s),(!z||1024&e)&&O!==(O=t[10].length+"")&&x(R,O),(!z||1024&e)&&X!==(X=t[10][0].length+"")&&x(S,X);const o={};1024&e&&(o.data=t[10]),64&e&&(o.highlights=t[6]),8&e&&(o.outputLength=t[3].length),8&e&&(o.constraint=Et(t[3].length)),16&e&&(o.dataRange=t[4]),1&e&&(o.stride=t[0]),H.$set(o)},i(t){z||(q(y.$$.fragment,t),q(w.$$.fragment,t),q(I.$$.fragment,t),q(H.$$.fragment,t),z=!0)},o(t){j(y.$$.fragment,t),j(w.$$.fragment,t),j(I.$$.fragment,t),j(H.$$.fragment,t),z=!1},d(t){t&&g(e),W(y),t&&g(m),t&&g(v),W(w),W(I),t&&g(L),t&&g(M),W(H)}}}function ae(t,e,a){let{stride:l}=e,{dilation:n}=e,{kernelLength:s}=e,{image:r}=e,{output:o}=e,{isPaused:i}=e,{dataRange:d}=e;const c=A();let g=r.length+0,p=[];for(let t=0;t<s;t++){p.push([]);for(let e=0;e<s;e++)p[t].push(0)}p=Ct(p);let u,h,y=Ct([[0]]),m=[],f=wt(o.length*o.length,t=>!0);function x(t){h=0;let e=It(t,o,s,g,n);t<=0||(u&&clearInterval(u),a(14,u=setInterval(()=>{if(i)return;const t=h%(o.length*o.length);a(6,f=wt(o.length*o.length,t=>!1));const l=Math.floor(t/o.length),n=t%o.length;a(6,f[l*o.length+n]=!0,f),a(5,m=Lt(l,n,g,0,e,s));const d=Mt(r,m,s);a(7,p=Ct(d));const c=At(o,f);a(8,y=Ct(c)),h++},250)))}x(l);let v=Ct(r),b=Ct(o);return t.$$set=t=>{"stride"in t&&a(0,l=t.stride),"dilation"in t&&a(13,n=t.dilation),"kernelLength"in t&&a(1,s=t.kernelLength),"image"in t&&a(2,r=t.image),"output"in t&&a(3,o=t.output),"isPaused"in t&&a(12,i=t.isPaused),"dataRange"in t&&a(4,d=t.dataRange)},t.$$.update=()=>{if(4&t.$$.dirty&&(g=r.length+0),8&t.$$.dirty){wt(o.length*o.length,t=>!0)}13&t.$$.dirty&&(x(l),a(9,v=Ct(r)),a(10,b=Ct(o)))},[l,s,r,o,d,m,f,p,y,v,b,function(t){let e=It(l,o,s,g,n);a(6,f=wt(o.length*o.length,t=>!1));const d=t.detail.hoverH,u=t.detail.hoverW;a(6,f[d*o.length+u]=!0,f),a(5,m=Lt(d,u,g,0,e,s));const h=Mt(r,m,s);a(7,p=Ct(h));const x=At(o,f);a(8,y=Ct(x)),a(12,i=!0),c("message",{text:i})},i,n,u]}class le extends U{constructor(t){super(),Y(this,t,ae,ee,s,{stride:0,dilation:13,kernelLength:1,image:2,output:3,isPaused:12,dataRange:4})}}function ne(t){let e,a,n,s,r,o,i,u,y,x,v,b,$,w,k,I,L,M,A,E=t[4]?'<i class="fas fa-play-circle play-icon"></i>':'<i class="fas fa-pause-circle"></i>';return w=new le({props:{kernelLength:t[1],image:t[0],output:t[5],stride:re,dilation:oe,isPaused:t[4],dataRange:t[2]}}),w.$on("message",t[7]),{c(){e=p("div"),a=p("div"),n=p("div"),s=p("div"),s.textContent="Max Pooling",r=h(),o=p("div"),i=p("div"),i.innerHTML='<i class="fas fa-info-circle"></i>',u=h(),y=p("div"),x=h(),v=p("div"),v.innerHTML='<i class="fas control-icon fa-times-circle"></i>',b=h(),$=p("div"),V(w.$$.fragment),k=h(),I=p("div"),I.innerHTML='<img src="/cnn-vis/assets/img/pointer.svg" alt="pointer icon" class="svelte-kahisg"/> \n          <div class="annotation-text"><span style="font-weight:600">Hover over</span> the matrices to change kernel position.</div>',f(s,"class","title-text svelte-kahisg"),f(i,"class","control-button svelte-kahisg"),f(i,"title","Jump to article section"),f(y,"class","play-button control-button svelte-kahisg"),f(y,"title","Play animation"),f(v,"class","delete-button control-button svelte-kahisg"),f(v,"title","Close"),f(o,"class","buttons svelte-kahisg"),f(n,"class","control-pannel svelte-kahisg"),f($,"class","container is-centered is-vcentered svelte-kahisg"),f(I,"class","annotation svelte-kahisg"),f(a,"class","box svelte-kahisg"),f(e,"class","container svelte-kahisg")},m(l,g){c(l,e,g),d(e,a),d(a,n),d(n,s),d(n,r),d(n,o),d(o,i),d(o,u),d(o,y),y.innerHTML=E,d(o,x),d(o,v),d(a,b),d(a,$),D(w,$,null),d(a,k),d(a,I),L=!0,M||(A=[m(i,"click",ie),m(y,"click",t[6]),m(v,"click",t[8])],M=!0)},p(t,e){(!L||16&e)&&E!==(E=t[4]?'<i class="fas fa-play-circle play-icon"></i>':'<i class="fas fa-pause-circle"></i>')&&(y.innerHTML=E);const a={};2&e&&(a.kernelLength=t[1]),1&e&&(a.image=t[0]),32&e&&(a.output=t[5]),16&e&&(a.isPaused=t[4]),4&e&&(a.dataRange=t[2]),w.$set(a)},i(t){L||(q(w.$$.fragment,t),L=!0)},o(t){j(w.$$.fragment,t),L=!1},d(t){t&&g(e),W(w),M=!1,l(A)}}}function se(t){let e,a,l=!t[3]&&ne(t);return{c(){l&&l.c(),e=y()},m(t,n){l&&l.m(t,n),c(t,e,n),a=!0},p(t,[a]){t[3]?l&&(F(),j(l,1,1,()=>{l=null}),T()):l?(l.p(t,a),8&a&&q(l,1)):(l=ne(t),l.c(),q(l,1),l.m(e.parentNode,e))},i(t){a||(q(l),a=!0)},o(t){j(l),a=!1},d(t){l&&l.d(t),t&&g(e)}}}let re=2;const oe=1;function ie(){let t=Number(d3.select("#cnn-svg").style("height").replace("px",""))+150,e=new SmoothScroll('a[href*="#"]',{offset:-t}),a=document.querySelector("#article-pooling");e.animateScroll(a)}function de(t,e,a){let{input:l}=e,{kernelLength:n}=e,{dataRange:s}=e,{isExited:r}=e;const o=A();var i=!1,d=$t(l);return t.$$set=t=>{"input"in t&&a(0,l=t.input),"kernelLength"in t&&a(1,n=t.kernelLength),"dataRange"in t&&a(2,s=t.dataRange),"isExited"in t&&a(3,r=t.isExited)},t.$$.update=()=>{if(1&t.$$.dirty)try{a(5,d=$t(l))}catch{console.log("Cannot handle stride of "+re)}},[l,n,s,r,i,d,function(){a(4,i=!i),console.log(i)},function(t){a(4,i=t.detail.text)},function(){o("message",{text:!0})}]}class ce extends U{constructor(t){super(),Y(this,t,de,se,s,{input:0,kernelLength:1,dataRange:2,isExited:3})}}function ge(e){let a,n,s,r,o,i,y,v,b,$,w,k,I,L,M,A,E,R,C;return{c(){var t;a=p("div"),n=p("div"),s=p("div"),r=p("div"),r.innerHTML='<i class="fas fa-info-circle"></i>',o=h(),i=p("div"),i.innerHTML='<i class="fas control-icon fa-times-circle"></i>',y=h(),v=p("div"),b=u("Softmax Score for "),$=p("i"),w=u('"'),k=u(e[0]),I=u('"'),L=h(),t="svg",M=document.createElementNS("http://www.w3.org/2000/svg",t),A=h(),E=p("div"),E.innerHTML='<img src="/cnn-vis/assets/img/pointer.svg" alt="pointer icon" class="svelte-1uac4ng"/> \n      <div class="annotation-text"><span style="font-weight:600">Hover over</span> the numbers to highlight logit circles.</div>',f(r,"class","control-button svelte-1uac4ng"),f(r,"title","Jump to article section"),f(i,"class","delete-button control-button svelte-1uac4ng"),f(i,"title","Close"),f(s,"class","buttons svelte-1uac4ng"),f(v,"class","title-text svelte-1uac4ng"),f(M,"id","softmax-svg"),f(M,"width","470"),f(M,"height","105"),f(M,"class","svelte-1uac4ng"),f(E,"class","annotation svelte-1uac4ng"),f(n,"class","box svelte-1uac4ng"),f(a,"class","container")},m(t,l){c(t,a,l),d(a,n),d(n,s),d(s,r),d(s,o),d(s,i),d(n,y),d(n,v),d(v,b),d(v,$),d($,w),d($,k),d($,I),d(n,L),d(n,M),d(n,A),d(n,E),e[10](a),R||(C=[m(r,"click",pe),m(i,"click",e[2])],R=!0)},p(t,[e]){1&e&&x(k,t[0])},i:t,o:t,d(t){t&&g(a),e[10](null),R=!1,l(C)}}}function pe(){let t=Number(d3.select("#cnn-svg").style("height").replace("px",""))+150,e=new SmoothScroll('a[href*="#"]',{offset:-t}),a=document.querySelector("#article-softmax");e.animateScroll(a)}function ue(t,e,a){let l,{logits:n}=e,{logitColors:s}=e,{selectedI:r}=e,{highlightI:o=-1}=e,{outputName:i}=e,{outputValue:d}=e,{startAnimation:c}=e,g=null;const p=A(),u=(t,e)=>void 0===e?d3.format(".2f")(t):d3.format(`.${e}f`)(t),h=(t,e,l,n)=>{a(3,o=n),p("mouseOver",{curI:n})},y=(t,e,l,n)=>{a(3,o=-1),p("mouseLeave",{curI:n})};return L(()=>{a(9,g=d3.select(l).select("#softmax-svg"));let t=g.append("g").attr("class","formula-right").attr("transform","translate(10, 0)").style("font-size","15px"),e=t.append("g").attr("class","denominator").attr("transform","translate(0, 58)");e.append("text").attr("x",0).attr("y",0).style("fill","gray").text("(");let o=8;n.forEach((t,a)=>{a/4>=1&&a%4==0&&(o=8);let l=e.append("text").attr("x",o).attr("y",20*Math.floor(a/4)).style("cursor","crosshair").style("pointer-events","all").on("mouseover",(t,e,l)=>h(0,0,0,a)).on("mouseleave",(t,e,l)=>y(0,0,0,a)).text("exp(");l.append("tspan").attr("class",`formula-term-${a} formula-term`).attr("dx","1").style("fill",s[a]).style("fill-opacity",a===r||c.hasInitialized?1:0).text(u(t)),l.append("tspan").attr("dx","1").text(")");let i=l.node().getBBox();o+=i.width+4,a!==n.length-1?(e.append("text").attr("x",o).attr("y",20*Math.floor(a/4)).text("+"),o+=14):e.append("text").attr("x",o-2).attr("y",20*Math.floor(a/4)).style("fill","gray").text(")")}),e.selectAll("text").data(n).enter().append("text").attr("x",(t,e)=>40*e).attr("y",0).text(t=>u(t));let i=e.node().getBBox();t.append("line").attr("class","separation-line").attr("x1",-5).attr("x2",i.width+5).attr("y1",32).attr("y2",32).style("stroke-width",1.2).style("stroke","gray");let p=t.append("g").attr("class","numerator-group").attr("transform","translate(0, 20)").append("text").attr("x",i.x+i.width/2).attr("y",0).on("mouseover",(t,e,a)=>h(0,0,0,r)).on("mouseleave",(t,e,a)=>y(0,0,0,r)).style("pointer-events","all").style("cursor","crosshair").style("text-anchor","middle").text("exp(");p.append("tspan").attr("class",`formula-term-${r} formula-term`).attr("dx",1).style("fill",s[r]).text(""+u(n[r])),p.append("tspan").attr("dx",1).text(")");let m=g.append("g").attr("class","formula-left").attr("transform","translate(395, 32)");m.append("text").attr("x",20).attr("dominant-baseline","middle").text(""+u(d,4)).node().getBBox();m.append("text").attr("dominant-baseline","middle").attr("x",0).attr("y",0).style("fill","gray").style("font-weight","bold").text("=")}),t.$$set=t=>{"logits"in t&&a(4,n=t.logits),"logitColors"in t&&a(5,s=t.logitColors),"selectedI"in t&&a(6,r=t.selectedI),"highlightI"in t&&a(3,o=t.highlightI),"outputName"in t&&a(0,i=t.outputName),"outputValue"in t&&a(7,d=t.outputValue),"startAnimation"in t&&a(8,c=t.startAnimation)},t.$$.update=()=>{520&t.$$.dirty&&null!==g&&(g.selectAll(".formula-term").style("text-decoration","none").style("font-weight","normal"),g.selectAll(".formula-term-"+o).style("font-weight","bold").style("text-decoration","underline")),768&t.$$.dirty&&null!==g&&g.select(".formula-term-"+c.i).transition("softmax-edge").duration(c.duration).style("fill-opacity",1)},[i,l,()=>{p("xClicked",{})},o,n,s,r,d,c,g,function(t){R[t?"unshift":"push"](()=>{l=t,a(1,l)})}]}class he extends U{constructor(t){super(),Y(this,t,ue,ge,s,{logits:4,logitColors:5,selectedI:6,highlightI:3,outputName:0,outputValue:7,startAnimation:8})}}function ye(e){let a,n,s,r,o,i,y,$,k,I,L,M,A,E,R,C,S,_,N,H,z,P,B,O,X,G,F,T,q,j,V,D,W,K,Y,U,J,Q=e[5].error+"";return{c(){a=p("div"),n=p("div"),s=p("div"),r=h(),o=p("div"),i=p("header"),y=p("p"),y.textContent="Add Input Image",$=h(),k=p("button"),I=h(),L=p("section"),M=p("div"),A=p("div"),E=p("input"),R=h(),C=p("span"),C.innerHTML='<i class="fas fa-link"></i>',S=h(),_=p("div"),_.textContent="or",N=h(),H=p("div"),z=p("label"),P=p("input"),B=h(),O=p("span"),O.innerHTML='<span class="file-icon"><i class="fas fa-upload"></i></span> \n                <span class="file-label">Upload</span>',X=h(),G=p("footer"),F=p("div"),T=u(Q),q=h(),j=p("div"),V=p("button"),V.textContent="Cancel",D=h(),W=p("button"),W.textContent="Add",K=h(),Y=p("img"),f(s,"class","modal-background"),f(y,"class","modal-card-title svelte-1o5lxfe"),f(k,"class","delete"),f(k,"aria-label","close"),f(i,"class","modal-card-head svelte-1o5lxfe"),f(E,"class","input small-font svelte-1o5lxfe"),f(E,"type","url"),f(E,"placeholder","Paste URL of image..."),f(C,"class","icon small-font is-left svelte-1o5lxfe"),f(A,"class","control has-icons-left svelte-1o5lxfe"),w(A,"is-loading",e[3]),f(_,"class","or-label svelte-1o5lxfe"),f(P,"class","file-input"),f(P,"type","file"),f(P,"name","image"),f(P,"accept",".png,.jpeg,.tiff,.jpg,.png"),f(O,"class","file-cta small-font svelte-1o5lxfe"),f(z,"class","file-label"),f(H,"class","file"),f(M,"class","field svelte-1o5lxfe"),f(L,"class","modal-card-body"),f(F,"class","error-message svelte-1o5lxfe"),w(F,"hidden",!e[5].show),f(V,"class","button is-smaller svelte-1o5lxfe"),f(W,"class","button is-success is-smaller svelte-1o5lxfe"),f(j,"class","button-container"),f(G,"class","modal-card-foot svelte-1o5lxfe"),f(o,"class","modal-card svelte-1o5lxfe"),f(n,"class","modal"),f(n,"id","input-modal"),w(n,"is-active",e[6].show),b(Y,"display","none"),f(Y,"id","vali-image"),f(Y,"alt","hidden image"),f(a,"class","modal-component")},m(t,l){c(t,a,l),d(a,n),d(n,s),d(n,r),d(n,o),d(o,i),d(i,y),d(i,$),d(i,k),d(o,I),d(o,L),d(L,M),d(M,A),d(A,E),v(E,e[2]),d(A,R),d(A,C),d(M,S),d(M,_),d(M,N),d(M,H),d(H,z),d(z,P),d(z,B),d(z,O),d(o,X),d(o,G),d(G,F),d(F,T),d(G,q),d(G,j),d(j,V),d(j,D),d(j,W),d(a,K),d(a,Y),e[14](Y),e[15](a),U||(J=[m(s,"click",e[10]),m(k,"click",e[10]),m(E,"input",e[12]),m(P,"change",e[13]),m(P,"change",e[9]),m(V,"click",e[10]),m(W,"click",e[11]),m(Y,"error",e[7]),m(Y,"load",e[8])],U=!0)},p(t,[e]){4&e&&v(E,t[2]),8&e&&w(A,"is-loading",t[3]),32&e&&Q!==(Q=t[5].error+"")&&x(T,Q),32&e&&w(F,"hidden",!t[5].show),64&e&&w(n,"is-active",t[6].show)},i:t,o:t,d(t){t&&g(a),e[14](null),e[15](null),U=!1,l(J)}}}function me(t,e,a){let l,n,s,r="",o=!1,i=!0,d={show:!1,error:""};const c=A();let g={show:!1};ht.set(g),ht.subscribe(t=>{a(6,g=t)});return L(()=>{d3.select(l).select("#input-modal")}),[l,n,r,o,s,d,g,()=>{a(3,o=!1),a(5,d.show=!0,d),a(5,d.error=i?"We can't find the image at that URL.":"Not a valid image file.",d)},()=>{let t=document.createElement("canvas"),e=t.getContext("2d");t.width=n.width,t.height=n.height,e.drawImage(n,0,0);try{e.getImageData(0,0,n.width,n.height),a(3,o=!1),a(6,g.show=!1,g),ht.set(g),c("urlTyped",{url:n.src}),a(2,r=null)}catch(t){a(3,o=!1),a(5,d.show=!0,d),a(5,d.error="No permission to load this image.",d)}},()=>{i=!1;let t=new FileReader;t.onload=t=>{a(1,n.src=t.target.result,n)},t.readAsDataURL(s[0])},()=>{a(6,g.show=!1,g),ht.set(g),c("xClicked",{preImage:g.preImage})},()=>{a(3,o=!0),a(5,d.show=!1,d),a(1,n.crossOrigin="Anonymous",n),a(1,n.src=r,n)},function(){r=this.value,a(2,r)},function(){s=this.files,a(4,s)},function(t){R[t?"unshift":"push"](()=>{n=t,a(1,n)})},function(t){R[t?"unshift":"push"](()=>{l=t,a(0,l)})}]}class fe extends U{constructor(t){super(),Y(this,t,me,ye,s,{})}}const xe="input",ve="conv",be="pool",$e="relu",we="fc",ke="flatten";class Ie{constructor(t,e,a,l,n){this.layerName=t,this.index=e,this.type=a,this.bias=l,this.output=n,this.inputLinks=[],this.outputLinks=[]}}class Le{constructor(t,e,a){this.source=t,this.dest=e,this.weight=a}}const Me=async(t,e)=>{let a=await Ee(t,!0),l=tf.stack([a]),n=[];for(let t=0;t<e.layers.length;t++){let a=e.layers[t].apply(l),s=a.squeeze();3===s.shape.length&&(s=s.transpose([2,0,1])),n.push(s),l=a}return((t,e,a)=>{let l=[],n=[],s=e.layers[0].batchInputShape.slice(1),r=a.transpose([2,0,1]).arraySync();for(let t=0;t<s[2];t++){let e=new Ie("input",t,xe,0,r[t]);n.push(e)}l.push(n);let o=1;for(let a=0;a<e.layers.length;a++){let n=e.layers[a],s=t[a].squeeze();s=s.arraySync();let r,i=[];switch(n.name.includes("conv")?r=ve:n.name.includes("pool")?r=be:n.name.includes("relu")?r=$e:n.name.includes("output")?r=we:n.name.includes("flatten")?r=ke:console.log("Find unknown type"),r){case ve:{let t=n.bias.val.arraySync(),e=n.kernel.val.transpose([3,2,0,1]).arraySync();for(let a=0;a<s.length;a++){let d=new Ie(n.name,a,r,t[a],s[a]);for(let t=0;t<l[o-1].length;t++){let n=l[o-1][t],s=new Le(n,d,e[a][t]);n.outputLinks.push(s),d.inputLinks.push(s)}i.push(d)}break}case we:{let t=n.bias.val.arraySync(),e=n.kernel.val.transpose([1,0]).arraySync();for(let a=0;a<s.length;a++){let d=new Ie(n.name,a,r,t[a],s[a]),c=0;for(let t=0;t<l[o-1].length;t++){let n=l[o-1][t],s=new Le(n,d,e[a][t]);n.outputLinks.push(s),d.inputLinks.push(s),c+=n.output*e[a][t]}c+=t[a],d.logit=c,i.push(d)}l[o-1].sort((t,e)=>t.realIndex-e.realIndex);break}case $e:case be:{let t=0,e=null;for(let a=0;a<s.length;a++){let d=new Ie(n.name,a,r,t,s[a]),c=l[o-1][a],g=new Le(c,d,e);c.outputLinks.push(g),d.inputLinks.push(g),i.push(d)}break}case ke:{let t=0;for(let e=0;e<s.length;e++){let a=l[o-1][0].output.length,d=l[o-1].length,c=e%d,g=Math.floor(Math.floor(e/d)/a),p=Math.floor(e/d)%a,u=c*(a*a)+g*a+p,h=new Ie(n.name,e,r,t,s[e]);h.realIndex=u;let y=new Le(l[o-1][c],h,[g,p]);l[o-1][c].outputLinks.push(y),h.inputLinks.push(y),i.push(h)}i.sort((t,e)=>t.index-e.index);break}default:console.error("Encounter unknown layer type")}l.push(i),o++}return l})(n,e,a)},Ae=(t,e,a,l=!0)=>{let n=tf.fill([e,a,3],0).arraySync();for(let s=0;s<t.length;s++){let r=Math.floor(s/4),o=s%4,i=e===a?Math.floor(r/e):r%e,d=e===a?r%e:Math.floor(r/e);if(o<3){let e=t[s];l&&(e/=255),n[i][d][o]=e}}return 64!=e&&64!=a&&(n=(t=>{let e,a=t.length,l=t[0].length;if(a<64||l<64){let e=Math.min(a,l),n=Math.floor(a/2)-e/2,s=Math.floor(l/2)-e/2;t.slice(n,n+e).map(t=>t.slice(s,s+e))}else{let n=Math.floor(a/2)-Math.floor(32),s=Math.floor(l/2)-Math.floor(32);e=t.slice(n,n+64).map(t=>t.slice(s,s+64))}return e})(n)),tf.tensor3d(n)},Ee=(t,e=!0)=>{let a=document.createElement("canvas");a.style.cssText="display:none;",document.getElementsByTagName("body")[0].appendChild(a);let l=a.getContext("2d");return new Promise((n,s)=>{let r,o=new Image;o.crossOrigin="Anonymous",o.src=t,o.onload=()=>{if(a.width=o.width,a.height=o.height,o.width>64||o.height>64){let t=document.createElement("canvas"),e=t.getContext("2d");const a=65/Math.min(o.width,o.height);t.width=o.width*a,t.height=o.height*a,e.drawImage(o,0,0,t.width,t.height),o.width!=o.height&&(l.translate(t.width,0),l.scale(-1,1),l.translate(t.width/2,t.height/2),l.rotate(90*Math.PI/180)),o.width!=o.height?l.drawImage(t,-t.width/2,-t.height/2):l.drawImage(t,0,0),r=l.getImageData(0,0,t.width,t.height)}else l.drawImage(o,0,0),r=l.getImageData(0,0,o.width,o.height);let t=r.data,s=r.width,i=r.height;a.parentNode.removeChild(a),n(Ae(t,s,i,e))},o.onerror=s})};const Re={nodeLength:40,plusSymbolRadius:8,numLayers:12,edgeOpacity:.8,edgeInitColor:"rgb(230, 230, 230)",edgeHoverColor:"rgb(130, 130, 130)",edgeHoverOuting:!1,edgeStrokeWidth:.7,intermediateColor:"gray",layerColorScales:{input:[d3.interpolateGreys,d3.interpolateGreys,d3.interpolateGreys],conv:d3.interpolateRdBu,relu:d3.interpolateRdBu,pool:d3.interpolateRdBu,fc:d3.interpolateGreys,weight:d3.interpolateBrBG,logit:d3.interpolateOranges},svgPaddings:{top:25,bottom:25,left:50,right:50},kernelRectLength:8/3,gapRatio:4,overlayRectOffset:12,classLists:["lifeboat","ladybug","pizza","bell pepper","school bus","koala","espresso","red panda","orange","sport car"]},Ce=Re.nodeLength,Se=t=>{let e=1/0,a=-1/0;if(void 0===t.length)return[t,t];if(void 0===t[0].length){for(let l=0;l<t[0].length;l++)t[l]<e?e=t[l]:t[l]>a&&(a=t[l]);return[e,a]}for(let l=0;l<t.length;l++)for(let n=0;n<t[0].length;n++)t[l][n]<e?e=t[l][n]:t[l][n]>a&&(a=t[l][n]);return[e,a]},_e=t=>({x:t.x+Ce,y:t.y+Ce/2}),Ne=t=>({x:t.x,y:t.y+Ce/2}),He=(t,e,a,l)=>(void 0===l&&(l=0),t((a+e/2)/e*(1-2*l)+l)),ze=Re.layerColorScales,Pe=Re.nodeLength,Be=Re.numLayers,Oe=Re.edgeOpacity,Xe=Re.edgeInitColor,Ge=Re.edgeStrokeWidth,Fe=Re.svgPaddings,Te=Re.gapRatio,qe=Re.classLists,je=d3.format(".4f");let Ve=void 0;tt.subscribe(t=>{Ve=t});let De=void 0;et.subscribe(t=>{De=t});let We=void 0;at.subscribe(t=>{We=t});let Ke=void 0;Z.subscribe(t=>{Ke=t});let Ye=void 0;lt.subscribe(t=>{Ye=t});let Ue=void 0;nt.subscribe(t=>{Ue=t});let Je=void 0;st.subscribe(t=>{Je=t});let Qe=void 0;rt.subscribe(t=>{Qe=t});let Ze=void 0;it.subscribe(t=>{Ze=t});const ta=(t,e,a,l)=>{let n=a[e],s=ze[t.type];"input"===t.type&&(s=s[t.index]);let r=void 0===t.output.length?1:t.output.length,o=document.createElement("canvas"),i=o.getContext("2d");o.width=r,o.height=r;let d=i.getImageData(0,0,r,r),c=d.data;if(1===r)c[0]=t.output;else for(let e=0;e<c.length;e+=4){let a=Math.floor(e/4),n=Math.floor(a/r),o=a%r,i=void 0;i="input"===t.type||"fc"===t.type?d3.rgb(s(1-t.output[n][o])):d3.rgb(s((t.output[n][o]+l/2)/l)),c[e]=i.r,c[e+1]=i.g,c[e+2]=i.b,c[e+3]=255}let g=document.createElement("canvas");g.width=3*Pe,g.height=3*Pe;let p=g.getContext("2d");i.putImageData(d,0,0),p.drawImage(o,0,0,r,r,0,0,3*Pe,3*Pe);let u=g.toDataURL();d3.select(n).attr("xlink:href",u),o.remove(),g.remove()},ea=(t,e,a,l)=>{d3.select(a[e]).select("rect.output-rect").transition("output").delay(500).duration(800).ease(d3.easeCubicIn).attr("width",l(t.output))},aa=(t,e,a,l,n)=>{void 0===l&&(l=0),void 0===n&&(n=1);let s=t.append("defs").append("svg:linearGradient").attr("id",""+a).attr("x1","0%").attr("y1","100%").attr("x2","100%").attr("y2","100%").attr("spreadMethod","pad");for(let t=0;t<10;t++){let a=t/9,r=e(a*(n-l)+l);s.append("stop").attr("offset",100*a+"%").attr("stop-color",r).attr("stop-opacity",1)}},la=(t,e,a,l,n,s)=>{We=(t-Pe*Be)/(8+5*Te),at.set(We);let r=0;for(let t=0;t<Ke.length;t++){let o=Ke[t],i="output"===o[0].layerName;Ye.push([]),i||"conv"===o[0].type?r+=We*Te:r+=We;let d=r,c=a.append("g").attr("class","cnn-layer-group").attr("id","cnn-layer-group-"+t);De=(e-Pe*o.length)/(o.length+1),et.set(De);let g=c.selectAll("g.node-group").data(o,t=>t.index).enter().append("g").attr("class","node-group").style("cursor","pointer").style("pointer-events","all").on("click",s).on("mouseover",l).on("mouseleave",n).classed("node-output",i).attr("id",(e,a)=>{let l=a*Pe+(a+1)*De;return l+=Fe.top,Ye[t].push({x:d,y:l}),`layer-${t}-node-${a}`});c.selectAll("g.node-output").on("mouseover",(t,e,a)=>{l(t,e,a),ut.set({show:!0,text:"Output value: "+je(t.output)})}).on("mouseleave",(t,e,a)=>{n(t,e,a),ut.set({show:!1,text:"Output value: "+je(t.output)})}),"output"!==o[0].layerName?(g.append("image").attr("class","node-image").attr("width",Pe).attr("height",Pe).attr("x",d).attr("y",(e,a)=>Ye[t][a].y),g.append("rect").attr("class","bounding").attr("width",Pe).attr("height",Pe).attr("x",d).attr("y",(e,a)=>Ye[t][a].y).style("fill","none").style("stroke","gray").style("stroke-width",1).classed("hidden",!0)):(g.append("rect").attr("class","output-rect").attr("x",d).attr("y",(e,a)=>Ye[t][a].y+Pe/2+8).attr("height",Pe/4).attr("width",0).style("fill","gray"),g.append("text").attr("class","output-text").attr("x",d).attr("y",(e,a)=>Ye[t][a].y+Pe/2).style("dominant-baseline","middle").style("font-size","11px").style("fill","black").style("opacity",.5).text((t,e)=>qe[e])),r+=Pe}lt.set(Ye);let o=d3.scaleLinear().domain(Je.output).range([0,Pe]);for(let t=0;t<Ke.length;t++){let e=Je[Ue][t];Ve.select("g#cnn-layer-group-"+t).selectAll("image.node-image").each((t,a,l)=>ta(t,a,l,e))}Ve.selectAll("g.node-output").each((t,e,a)=>ea(t,e,a,o));let i=Ke.map(t=>"output"===t[0].layerName?{name:t[0].layerName,dimension:`(${t.length})`}:{name:t[0].layerName,dimension:`(${t[0].output.length}, ${t[0].output.length}, ${t.length})`}),d=Number(d3.select("#cnn-svg").style("height").replace("px",""))+150,c=new SmoothScroll('a[href*="#"]',{offset:-d}),g=Ve.selectAll("g.layer-detailed-label").data(i).enter().append("g").attr("class","layer-detailed-label").attr("id",(t,e)=>"layer-detailed-label-"+e).classed("hidden",!Ze).attr("transform",(t,e)=>`translate(${Ye[e][0].x+Pe/2}, ${(Fe.top+De)/2-6})`).style("cursor",t=>t.name.includes("output")?"default":"help").on("click",t=>{let e="";t.name.includes("conv")&&(e="convolution"),t.name.includes("relu")&&(e="relu"),t.name.includes("max_pool")&&(e="pooling"),t.name.includes("input")&&(e="input");let a=document.querySelector("#article-"+e);c.animateScroll(a)});g.append("title").text("Move to article section"),g.append("text").style("opacity",.7).style("dominant-baseline","middle").append("tspan").style("font-size","12px").text(t=>t.name).append("tspan").style("font-size","8px").style("font-weight","normal").attr("x",0).attr("dy","1.5em").text(t=>t.dimension);let p=Ve.selectAll("g.layer-label").data(i).enter().append("g").attr("class","layer-label").attr("id",(t,e)=>"layer-label-"+e).classed("hidden",Ze).attr("transform",(t,e)=>`translate(${Ye[e][0].x+Pe/2}, ${(Fe.top+De)/2+5})`).style("cursor",t=>t.name.includes("output")?"default":"help").on("click",t=>{let e="";t.name.includes("conv")&&(e="convolution"),t.name.includes("relu")&&(e="relu"),t.name.includes("max_pool")&&(e="pooling"),t.name.includes("input")&&(e="input");let a=document.querySelector("#article-"+e);c.animateScroll(a)});p.append("title").text("Move to article section"),p.append("text").style("dominant-baseline","middle").style("opacity",.8).text(t=>t.name.includes("conv")?"conv":t.name.includes("relu")?"relu":t.name.includes("max_pool")?"max_pool":t.name),aa(Ve,ze.conv,"convGradient"),aa(Ve,ze.input[0],"inputGradient");((t,e)=>{for(let a=0;a<2;a++){let l=1+5*a,n=Je.local[l],s=Je.local[l+2],r=d3.scaleLinear().range([0,2*Pe+We-1.2]).domain([-n/2,n/2]),o=d3.scaleLinear().range([0,3*Pe+2*We-1.2]).domain([-s/2,s/2]),i=d3.axisBottom().scale(r).tickFormat(d3.format(".2f")).tickValues([-n/2,0,n/2]),d=d3.axisBottom().scale(o).tickFormat(d3.format(".2f")).tickValues([-s/2,0,s/2]),c=t.append("g").attr("class","legend local-legend").attr("id",`local-legend-${a}-1`).classed("hidden",!Ze||"local"!==Ue).attr("transform",`translate(${Ye[l][0].x}, 0)`);c.append("g").attr("transform",`translate(0, ${e-3})`).call(i),c.append("rect").attr("width",2*Pe+We).attr("height",e).style("fill","url(#convGradient)");let g=t.append("g").attr("class","legend local-legend").attr("id",`local-legend-${a}-2`).classed("hidden",!Ze||"local"!==Ue).attr("transform",`translate(${Ye[l+2][0].x}, 0)`);g.append("g").attr("transform",`translate(0, ${e-3})`).call(d),g.append("rect").attr("width",3*Pe+2*We).attr("height",e).style("fill","url(#convGradient)")}for(let a=0;a<2;a++){let l=1+5*a,n=Je.module[l],s=d3.scaleLinear().range([0,5*Pe+3*We+1*We*Te-1.2]).domain([-n/2,n/2]),r=d3.axisBottom().scale(s).tickFormat(d3.format(".2f")).tickValues([-n/2,-n/4,0,n/4,n/2]),o=t.append("g").attr("class","legend module-legend").attr("id","module-legend-"+a).classed("hidden",!Ze||"module"!==Ue).attr("transform",`translate(${Ye[l][0].x}, 0)`);o.append("g").attr("transform",`translate(0, ${e-3})`).call(r),o.append("rect").attr("width",5*Pe+3*We+1*We*Te).attr("height",e).style("fill","url(#convGradient)")}let a=Je.global[1],l=d3.scaleLinear().range([0,10*Pe+6*We+3*We*Te-1.2]).domain([-a/2,a/2]),n=d3.axisBottom().scale(l).tickFormat(d3.format(".2f")).tickValues([-a/2,-a/4,0,a/4,a/2]),s=t.append("g").attr("class","legend global-legend").attr("id","global-legend").classed("hidden",!Ze||"global"!==Ue).attr("transform",`translate(${Ye[1][0].x}, 0)`);s.append("g").attr("transform",`translate(0, ${e-3})`).call(n),s.append("rect").attr("width",10*Pe+6*We+3*We*Te).attr("height",e).style("fill","url(#convGradient)");let r=d3.scaleLinear().domain(Je.output).range([0,Pe-1.2]),o=d3.axisBottom().scale(r).tickFormat(d3.format(".1f")).tickValues([0,Je.output[1]]),i=t.append("g").attr("class","legend output-legend").attr("id","output-legend").classed("hidden",!Ze).attr("transform",`translate(${Ye[11][0].x}, 0)`);i.append("g").attr("transform",`translate(0, ${e-3})`).call(o),i.append("rect").attr("width",Pe).attr("height",e).style("fill","gray");let d=d3.scaleLinear().range([0,Pe-1.2]).domain([0,1]),c=d3.axisBottom().scale(d).tickFormat(d3.format(".1f")).tickValues([0,.5,1]),g=t.append("g").attr("class","legend input-legend").classed("hidden",!Ze).attr("transform",`translate(${Ye[0][0].x}, 0)`);g.append("g").attr("transform",`translate(0, ${e-3})`).call(c),g.append("rect").attr("x",.3).attr("width",Pe-.3).attr("height",e).attr("transform",`rotate(180, ${Pe/2}, ${e/2})`).style("stroke","rgb(20, 20, 20)").style("stroke-width",.3).style("fill","url(#inputGradient)")})(Ve.append("g").attr("class","color-legend").attr("transform",`translate(0, ${Fe.top+10*De+De+10*Pe})`),5);let u=d3.linkHorizontal().x(t=>t.x).y(t=>t.y),h=((t,e)=>{let a=[];for(let l=1;l<e.length;l++)for(let n=0;n<e[l].length;n++){let s="output"===e[l][n].layerName,r=Ne(t[l][n]);for(let o=0;o<e[l][n].inputLinks.length;o++){let i=e[l][n].inputLinks[o].source.index;if(s){let t=e[l-1][0].output.length*e[l-1][0].output.length;if(i%t!=0)continue;i=Math.floor(i/t)}let d=_e(t[l-1][i]),c=e[l][n].inputLinks[o].weight;a.push({source:d,target:r,weight:c,targetLayerIndex:l,targetNodeIndex:n,sourceNodeIndex:i})}}return a})(Ye,Ke);a.append("g").attr("class","edge-group").selectAll("path.edge").data(h).enter().append("path").attr("class",t=>`edge edge-${t.targetLayerIndex} edge-${t.targetLayerIndex}-${t.targetNodeIndex}`).attr("id",t=>`edge-${t.targetLayerIndex}-${t.targetNodeIndex}-${t.sourceNodeIndex}`).attr("d",t=>u({source:t.source,target:t.target})).style("fill","none").style("stroke-width",Ge).style("opacity",Oe).style("stroke",Xe);let y=a.append("g").attr("class","input-annotation"),m=y.append("text").attr("x",Ye[0][0].x+Pe/2).attr("y",Ye[0][0].y+Pe+5).attr("class","annotation-text").style("dominant-baseline","hanging").style("text-anchor","middle");m.append("tspan").style("dominant-baseline","hanging").style("fill","#C95E67").text("Red"),m.append("tspan").style("dominant-baseline","hanging").text(" channel"),y.append("text").attr("x",Ye[0][1].x+Pe/2).attr("y",Ye[0][1].y+Pe+5).attr("class","annotation-text").style("dominant-baseline","hanging").style("text-anchor","middle").style("fill","#3DB665").text("Green"),y.append("text").attr("x",Ye[0][2].x+Pe/2).attr("y",Ye[0][2].y+Pe+5).attr("class","annotation-text").style("dominant-baseline","hanging").style("text-anchor","middle").style("fill","#3F7FBC").text("Blue")},na=()=>{let t=d3.scaleLinear().domain(Je.output).range([0,Pe]);for(let e=0;e<Ke.length;e++){let a=Ke[e],l=Je[Ue][e],n=Ve.select("g#cnn-layer-group-"+e).selectAll("g.node-group").data(a);e<Ke.length-1?n.transition("disappear").duration(300).ease(d3.easeCubicOut).style("opacity",0).on("end",(function(){d3.select(this).select("image.node-image").each((t,e,a)=>ta(t,e,a,l)),d3.select(this).transition("appear").duration(700).ease(d3.easeCubicIn).style("opacity",1)})):n.each((e,a,l)=>ea(e,a,l,t))}for(let t=0;t<2;t++){let e=1+5*t,a=Je.local[e],l=Je.local[e+2],n=d3.scaleLinear().range([0,2*Pe+We]).domain([-a/2,a/2]),s=d3.scaleLinear().range([0,3*Pe+2*We]).domain([-l/2,l/2]),r=d3.axisBottom().scale(n).tickFormat(d3.format(".2f")).tickValues([-a/2,0,a/2]),o=d3.axisBottom().scale(s).tickFormat(d3.format(".2f")).tickValues([-l/2,0,l/2]);Ve.select(`g#local-legend-${t}-1`).select("g").call(r),Ve.select(`g#local-legend-${t}-2`).select("g").call(o)}for(let t=0;t<2;t++){let e=1+5*t,a=Je.local[e],l=d3.scaleLinear().range([0,5*Pe+3*We+1*We*Te-1.2]).domain([-a,a]),n=d3.axisBottom().scale(l).tickFormat(d3.format(".2f")).tickValues([-a,-a/2,0,a/2,a]);Ve.select("g#module-legend-"+t).select("g").call(n)}let e=Je.global[1],a=d3.scaleLinear().range([0,10*Pe+6*We+3*We*Te-1.2]).domain([-e,e]),l=d3.axisBottom().scale(a).tickFormat(d3.format(".2f")).tickValues([-e,-e/2,0,e/2,e]);Ve.select("g#global-legend").select("g").call(l);let n=d3.axisBottom().scale(t).tickFormat(d3.format(".1f")).tickValues([0,Je.output[1]]);Ve.select("g#output-legend").select("g").call(n)},sa=()=>{let t=[1],e=void 0;Qe=[];for(let a=0;a<Ke.length-1;a++){let l=Ke[a],n=l.map(t=>Se(t.output)).reduce((t,e)=>[Math.min(t[0],e[0]),Math.max(t[1],e[1])]);Qe.push({min:n[0],max:n[1]}),"conv"!==l[0].type&&"fc"!==l[0].type||(n=n.map(Math.abs),e=2*(.1+Math.round(1e3*Math.max(...n))/1e3)),void 0!==e&&t.push(e)}t.push(1),Qe.push({min:0,max:1});let a=[1],l=(Be-2)/5;for(let e=0;e<l;e++){let l=t.slice(1+5*e,1+5*e+5),n=Math.max(...l);for(let t=0;t<5;t++)a.push(n)}a.push(1);let n=[1],s=Math.max(...t.slice(1,t.length-1));for(let t=0;t<Be-2;t++)n.push(s);n.push(1),Je.local=t,Je.module=a,Je.global=n,Je.output=[0,d3.max(Ke[Ke.length-1].map(t=>t.output))],st.set(Je),rt.set(Qe)},ra=Re.layerColorScales,oa=Re.nodeLength,ia=Re.intermediateColor,da=Re.svgPaddings;let ca=void 0;tt.subscribe(t=>{ca=t});let ga=void 0;et.subscribe(t=>{ga=t});const pa=t=>{let e=t.layerIndex,a=t.targetX,l=t.disable,n=t.delay,s=t.opacity,r=t.specialIndex,o=t.onEndFunc,i=void 0===t.transitionName?"move":t.transitionName,d=void 0===t.duration?500:t.duration;ca.select("g#cnn-layer-group-"+e).selectAll("g.node-group").each((t,e,o)=>{d3.select(o[e]).style("cursor",l&&e!==r?"default":"pointer").style("pointer-events",l&&e!==r?"none":"all").select("image").transition(i).ease(d3.easeCubicInOut).delay(n).duration(d).attr("x",a),d3.select(o[e]).select("rect.bounding").transition(i).ease(d3.easeCubicInOut).delay(n).duration(d).attr("x",a),void 0!==s&&e!==r&&d3.select(o[e]).select("image").style("opacity",s)}),ca.selectAll("g#layer-label-"+e).transition(i).ease(d3.easeCubicInOut).delay(n).duration(d).attr("transform",()=>`translate(${a+oa/2}, ${(da.top+ga)/2+5})`).on("end",o),ca.selectAll("g#layer-detailed-label-"+e).transition(i).ease(d3.easeCubicInOut).delay(n).duration(d).attr("transform",()=>`translate(${a+oa/2}, ${(da.top+ga)/2-6})`).on("end",o)},ua=(t,e,a)=>{void 0===a&&(a=ca);let l=a.append("defs").attr("class","overlay-gradient").append("linearGradient").attr("id",t).attr("x1","0%").attr("x2","100%").attr("y1","100%").attr("y2","100%");e.forEach(t=>{l.append("stop").attr("offset",t.offset).attr("stop-color",t.color).attr("stop-opacity",t.opacity)})},ha=t=>{let e=t.legendHeight,a=t.curLayerIndex,l=t.range,n=t.group,s=t.minMax,r=t.width,o=t.x,i=t.y,d=t.isInput,c=t.colorScale,g=t.gradientAppendingName,p=t.gradientGap;void 0===c&&(c=ra.conv),void 0===p&&(p=0);let u="url(#inputGradient)",h=t=>c(t*(1-2*p)+p);if(!d){let t=(s.min+l/2)/l,e=(0+l/2)/l,a=(s.max+l/2)/l,r=s.max-s.min,o=(0-s.min)/r,i=t+(e-t)/2,d=e+(a-e)/2,c=[{offset:0,color:h(t),opacity:1},{offset:o/2,color:h(i),opacity:1},{offset:o,color:h(e),opacity:1},{offset:o+(1-e)/2,color:h(d),opacity:1},{offset:1,color:h(a),opacity:1}];void 0===g?(ua("intermediate-legend-gradient",c,n),u="url(#intermediate-legend-gradient)"):(ua(""+g,c,n),u=`url(#${g})`)}let y=d3.scaleLinear().range([0,r-1.2]).domain(d?[0,l]:[s.min,s.max]),m=d3.axisBottom().scale(y).tickFormat(d3.format(d?"d":".2f")).tickValues(d?[0,l]:[s.min,0,s.max]),f=n.append("g").attr("class","intermediate-legend-"+(a-1)).attr("transform",`translate(${o}, ${i})`),x=f.append("g").attr("transform",`translate(0, ${e-3})`).call(m);x.selectAll("text").style("font-size","9px").style("fill",ia),x.selectAll("path, line").style("stroke",ia),f.append("rect").attr("width",r).attr("height",e).attr("transform",`rotate(${d?180:0},\n      ${r/2}, ${e/2})`).style("fill",u)},ya=t=>{let e=t.group,a=t.sx,l=t.sy,n=t.tx,s=t.ty,r=t.dr,o=t.hFlip,i=void 0===t.marker?"marker":t.marker;e.append("g").attr("class","arrow-group").append("path").attr("d",`M${a},${l}A${r},${r} 0 0,${o?0:1} ${n},${s}`).attr("marker-end",`url(#${i})`).style("stroke","gray").style("fill","none")},ma=Re.layerColorScales,fa=Re.nodeLength,xa=Re.plusSymbolRadius,va=Re.numLayers,ba=Re.intermediateColor,$a=Re.kernelRectLength,wa=Re.svgPaddings,ka=Re.gapRatio,Ia=Re.overlayRectOffset,La=d3.format(".4f");let Ma=!1,Aa=void 0;tt.subscribe(t=>{Aa=t});let Ea=void 0;et.subscribe(t=>{Ea=t});let Ra=void 0;at.subscribe(t=>{Ra=t});let Ca=void 0;Z.subscribe(t=>{Ca=t});let Sa=void 0;lt.subscribe(t=>{Sa=t});let _a=void 0;nt.subscribe(t=>{_a=t});let Na=void 0;st.subscribe(t=>{Na=t});let Ha=void 0;rt.subscribe(t=>{Ha=t});let za=[void 0,void 0];ot.subscribe(t=>{za=t});let Pa=void 0;dt.subscribe(t=>{Pa=t});let Ba=void 0;it.subscribe(t=>{Ba=t});let Oa=void 0;yt.subscribe(t=>{Oa=t});const Xa=(t,e,a,l,n)=>{const s=()=>{let r=+t.attr("data-origin-x"),o=+t.attr("data-origin-y"),i=+t.attr("data-tick"),d=i%e,c=Math.floor(i/e),g=r+d*a,p=o+c*a,u=(i+1)%(e*e);Aa.selectAll(`rect.mask-${d}-${c}`).transition("window-sliding-mask").delay(l+100).duration(300).style("opacity",0),t.attr("data-tick",u).transition("window-sliding-input").delay(l).duration(200).attr("transform",`translate(${g}, ${p})`).on("end",()=>{0===u&&(Ma||Fa(n)),Pa&&s()})};s()},Ga=(t,e,a,l)=>{const n=()=>{let s=+t.attr("data-origin-x"),r=+t.attr("data-origin-y"),o=+e.attr("data-origin-x"),i=+t.attr("data-tick"),d=i%a,c=Math.floor(i/a),g=s+d*l,p=r+c*l,u=o+i%a*l,h=(i+1)%(a*a);Aa.selectAll(`rect.mask-${d}-${c}`).transition("window-sliding-mask").delay(300).duration(300).style("opacity",0),t.attr("data-tick",h).transition("window-sliding-input").delay(200).duration(200).attr("transform",`translate(${g}, ${p})`),e.attr("data-tick",h).transition("window-sliding-result").delay(200).duration(200).attr("transform",`translate(${u}, ${p})`).on("end",()=>{Pa&&n()})};n()},Fa=t=>{null!==d3.event&&d3.event.stopPropagation();let e=fa/(3*$a),a=3*$a;if(Ma){dt.set(!0),Aa.selectAll(".kernel-clone").transition().duration(300).style("opacity",1),Aa.selectAll("rect.mask-overlay").transition().duration(300).style("opacity",1);for(let l=0;l<Sa[t-1].length;l++)Ga(d3.select(".kernel-input-"+l),d3.select(".kernel-result-"+l),e,a);Xa(d3.select(".kernel-output"),e,a,200,t),Aa.selectAll("path.flow-edge").attr("stroke-dasharray","4 2").attr("stroke-dashoffset",0).each((t,e,a)=>Ta(t,e,a,-1e3)),Aa.select(".animation-control-button").attr("xlink:href","/cnn-vis/assets/img/fast_forward.svg"),Ma=!1}else{dt.set(!1),Aa.selectAll("rect.mask-overlay").transition("skip").duration(600).style("opacity",0),Aa.selectAll(".kernel-clone").attr("data-tick",0).transition("skip").duration(300).style("opacity",0).on("end",(t,e,a)=>{let l=d3.select(a[e]),n=+l.attr("data-origin-x"),s=+l.attr("data-origin-y");l.attr("transform",`translate(${n}, ${s})`)}),Aa.selectAll("path.flow-edge").interrupt().attr("stroke-dasharray","0 0"),Aa.select(".animation-control-button").attr("xlink:href","/cnn-vis/assets/img/redo.svg"),Ma=!0}},Ta=(t,e,a,l)=>{d3.select(a[e]).transition().duration(6e4).ease(d3.easeLinear).attr("stroke-dashoffset",l).on("end",(t,e,a)=>{Pa&&Ta(t,e,a,l-2e3)})},qa=(t,e,a,l,n,s,r,o,i,d)=>{let c=Aa.append("g").attr("class","intermediate-layer").style("opacity",0);Ma=!1;let g=e+fa+n,p=g+fa+1.5*n,u=Na[_a][t],h=ma[s.type],y=[],m=[],f=s.inputLinks.map(t=>Se(t.weight)).reduce((t,e)=>[Math.min(t[0],e[0]),Math.max(t[1],e[1])]),x=Math.round(1e3*Math.max(...f.map(Math.abs)))/1e3*2,v=3*$a,b=Sa[t][r].y,$=Aa.select(`#layer-${t}-node-${r}`),w=$.append("g").attr("class","overlay-group").attr("transform",`translate(${a}, ${b})`),k=Math.floor(fa/v);for(let t=0;t<k;t++)for(let e=0;e<k;e++)w.append("rect").attr("class",`mask-overlay mask-${t}-${e}`).attr("width",v).attr("height",v).attr("x",t*v).attr("y",e*v).style("fill","var(--light-gray)").style("stroke","var(--light-gray)").style("opacity",1);$.select("rect.bounding").raise();let I=c.append("g").attr("class","kernel kernel-output kernel-clone").attr("transform",`translate(${a}, ${b})`);I.append("rect").attr("x",0).attr("y",0).attr("width",3*$a).attr("height",3*$a).attr("fill","none").attr("stroke",ba),I.attr("data-tick",0).attr("data-origin-x",a).attr("data-origin-y",b);let L=fa/(3*$a);Xa(I,L,v,200,t),Sa[t-1].forEach((a,l)=>{let n=Ca[t-1][l].output,f=Ca[t][r].inputLinks[l].weight,b=bt(n,f);y.push(Se(b)),((t,e,a,l,n)=>{let s=l,r=document.createElement("canvas"),o=r.getContext("2d");r.width=s,r.height=s;let i=o.getImageData(0,0,s,s),d=i.data;for(let t=0;t<d.length;t+=4){let l=Math.floor(t/4),r=Math.floor(l/s),o=l%s,i=d3.rgb(a((n[r][o]+e/2)/e));d[t]=i.r,d[t+1]=i.g,d[t+2]=i.b,d[t+3]=255}let c=document.createElement("canvas");c.width=3*fa,c.height=3*fa;let g=c.getContext("2d");o.putImageData(i,0,0),g.drawImage(r,0,0,s,s,0,0,3*fa,3*fa);let p=c.toDataURL();t.attr("xlink:href",p),r.remove(),c.remove()})(((t,e,a,l,n,s,r,o,i,d,c)=>{let g=a.append("g").datum(Ca[t-1][s]).attr("class","intermediate-node").attr("cursor",c?"pointer":"default").attr("pointer-events",c?"all":"none").attr("node-index",s).on("mouseover",o).on("mouseleave",i).on("click",(a,l,n)=>d(a,l,n,e,t));g.append("image").attr("width",fa).attr("height",fa).attr("x",l).attr("y",n);let p=Math.floor(fa/r),u=g.append("g").attr("class","overlay-group").attr("transform",`translate(${l}, ${n})`);for(let t=0;t<p;t++)for(let e=0;e<p;e++)u.append("rect").attr("class",`mask-overlay mask-${t}-${e}`).attr("width",r).attr("height",r).attr("x",t*r).attr("y",e*r).style("fill","var(--light-gray)").style("stroke","var(--light-gray)").style("opacity",1);return g.append("rect").attr("class","bounding").attr("width",fa).attr("height",fa).attr("x",l).attr("y",n).style("fill","none").style("stroke",ba).style("stroke-width",1),g})(t,r,c,g,a.y,l,v,o,i,d,!0).select("image"),u,h,s.output.length,b),m.push({source:_e({x:e,y:a.y}),target:Ne({x:g,y:a.y}),name:`input-${l}-inter1-${l}`}),m.push({source:_e({x:g,y:a.y}),target:Ne({x:p,y:Sa[t][r].y}),name:`inter1-${l}-inter2-1`});let $=e-3*$a*2,w=c.append("g").attr("class","kernel kernel-"+l).attr("transform",`translate(${$}, ${a.y})`),k="Kernel weights: [",I=d3.format(".2f");for(let t=0;t<f.length;t++)for(let e=0;e<f[0].length;e++){w.append("rect").attr("class","kernel").attr("x",$a*e).attr("y",$a*t).attr("width",$a).attr("height",$a).attr("fill",He(ma.weight,x,f[t][e],.2));let a="";a=0===e&&0==t?"":0===e?"; ":", ",k=k.concat(a,""+I(f[t][e]))}k=k.concat("]"),w.append("rect").attr("x",0).attr("y",0).attr("width",3*$a).attr("height",3*$a).attr("fill","none").attr("stroke",ba),w.style("pointer-events","all").style("cursor","crosshair").on("mouseover",()=>{ut.set({show:!0,text:k})}).on("mouseleave",()=>{ut.set({show:!1,text:k})}).on("click",()=>{d3.event.stopPropagation()});let M=w.clone(!0).style("pointer-events","none").style("cursor","pointer").classed("kernel-clone",!0).classed("kernel-input-"+l,!0);M.style("opacity",.9).selectAll("rect.kernel").style("opacity",.7),M.attr("transform",`translate(${e}, ${a.y})`).attr("data-tick",0).attr("data-origin-x",e).attr("data-origin-y",a.y);let A=w.clone(!0).style("pointer-events","none").style("cursor","pointer").classed("kernel-clone",!0).classed("kernel-result-"+l,!0);A.style("opacity",.9).selectAll("rect.kernel").style("fill","none"),A.attr("transform",`translate(${g}, ${a.y})`).attr("data-origin-x",g).attr("data-origin-y",a.y),Ga(M,A,L,v)});let M=y.reduce((t,e)=>[Math.min(t[0],e[0]),Math.max(t[1],e[1])]),A={min:M[0],max:M[1]},E=Sa[t][r].y+fa/2,R=c.append("g").attr("class","plus-symbol").attr("transform",`translate(${p+xa}, ${E})`);R.append("rect").attr("x",-xa).attr("y",-xa).attr("width",2*xa).attr("height",2*xa).attr("rx",3).attr("ry",3).style("fill","none").style("stroke",ba),R.append("rect").attr("x",-(xa-3)).attr("y",-.5).attr("width",2*(xa-3)).attr("height",1).style("fill",ba),R.append("rect").attr("x",-.5).attr("y",-(xa-3)).attr("width",1).attr("height",2*(xa-3)).style("fill",ba),0==r?(R.append("circle").attr("cx",0).attr("cy",fa/2+$a).attr("r",4).style("stroke",ba).style("cursor","crosshair").style("fill",He(ma.weight,x,s.bias,.2)).on("mouseover",()=>{ut.set({show:!0,text:"Bias: "+La(s.bias)})}).on("mouseleave",()=>{ut.set({show:!1,text:"Bias: "+La(s.bias)})}),m.push({source:{x:p+xa,y:Sa[t][r].y+fa},target:{x:p+xa,y:Sa[t][r].y+fa/2+xa},name:"bias-plus"})):(R.append("circle").attr("cx",0).attr("cy",-fa/2-$a).attr("r",4).style("stroke",ba).style("cursor","crosshair").style("fill",He(ma.weight,x,s.bias,.2)).on("mouseover",()=>{ut.set({show:!0,text:"Bias: "+La(s.bias)})}).on("mouseleave",()=>{ut.set({show:!1,text:"Bias: "+La(s.bias)})}),m.push({source:{x:p+xa,y:Sa[t][r].y},target:{x:p+xa,y:Sa[t][r].y+fa/2-xa},name:"bias-plus"})),m.push({source:_e({x:p+2*xa-fa,y:Sa[t][r].y}),target:Ne({x:a,y:Sa[t][r].y}),name:"symbol-output"}),m.push({source:_e({x:a,y:Sa[t][r].y}),target:Ne({x:l,y:Sa[t][r].y}),name:"output-next"}),c.append("g").attr("class","layer-intermediate-label layer-label").attr("transform",()=>`translate(${g+fa/2}, ${(wa.top+Ea)/2+5})`).classed("hidden",Ba).append("text").style("text-anchor","middle").style("dominant-baseline","middle").style("font-weight",800).style("opacity","0.8").text("intermediate"),c.append("g").attr("class","animation-control").attr("transform",()=>`translate(${g+fa/2}, ${(wa.top+Ea)/2-4})`).on("click",()=>Fa(t)).append("image").attr("class","animation-control-button").attr("xlink:href","/cnn-vis/assets/img/fast_forward.svg").attr("x",50).attr("y",0).attr("height",13).attr("width",13),c.append("g").attr("class","layer-intermediate-label layer-detailed-label").attr("transform",()=>`translate(${g+fa/2}, ${(wa.top+Ea)/2-5})`).classed("hidden",!Ba).append("text").style("text-anchor","middle").style("dominant-baseline","middle").style("opacity","0.7").style("font-weight",800).append("tspan").text("intermediate").append("tspan").style("font-size","8px").style("font-weight","normal").attr("x",0).attr("dy","1.5em").text(`(${Ca[t][0].output.length},\n      ${Ca[t][0].output[0].length},\n      ${Ca[t].length})`);let C=d3.linkHorizontal().x(t=>t.x).y(t=>t.y),S=c.append("g").attr("class","edge-group").lower();return S.selectAll("path").data(m).enter().append("path").classed("flow-edge",t=>"output-next"!==t.name).attr("id",t=>"edge-"+t.name).attr("d",t=>C({source:t.source,target:t.target})).style("fill","none").style("stroke-width",1).style("stroke",ba),S.select("#edge-output-next").style("opacity",.1),S.selectAll("path.flow-edge").attr("stroke-dasharray","4 2").attr("stroke-dashoffset",0).each((t,e,a)=>Ta(t,e,a,-1e3)),{intermediateLayer:c,intermediateMinMax:A,kernelRange:x,kernelMinMax:{min:f[0],max:f[1]}}},ja=t=>{let e,a,l,n,s,r,o,i,d,c,g,p,u=t.leftX,h=t.curLayerIndex,y=t.group,m=t.intermediateGap,f=t.isFirstConv,x=t.i,v=y.append("g").attr("class","kernel-annotation");v.append("text").text("Kernel").attr("class","annotation-text").attr("x",u-2.5*$a*3).attr("y",Sa[h-1][0].y+3*$a).style("dominant-baseline","baseline").style("text-anchor","end"),f?(e=u,a=Sa[h-1][0].y+fa+3*$a,l=u-5,n=Sa[h-1][0].y+fa+3*$a+5,s=20,r=u,o=Sa[h-1][1].y+fa+3*$a,i=u-3*$a,d=Sa[h-1][1].y+fa+15,g=u-13,p=Sa[h-1][1].y+15,c=35):(e=u-3*$a*3,a=Sa[h-1][0].y+fa/3,l=u-2*$a*3-5,n=Sa[h-1][0].y+fa-10,s=50,r=u-3*$a*3,o=Sa[h-1][2].y-3,g=u-3*$a-4,p=Sa[h-1][2].y+3*$a+6,i=u-3*$a-13,d=Sa[h-1][2].y+26,c=20);let b=v.append("text").attr("x",e).attr("y",a).attr("class","annotation-text").style("dominant-baseline","hanging").style("text-anchor",f?"start":"end");b.append("tspan").style("dominant-baseline","hanging").text("Slide kernel over input channel"),b.append("tspan").attr("x",e).attr("dy","1em").style("dominant-baseline","hanging").text("to get intermediate result"),b.append("tspan").attr("x",e).attr("dy","1.2em").style("dominant-baseline","hanging").style("font-weight",700).text("Click "),b.append("tspan").style("dominant-baseline","hanging").style("font-weight",400).text("to learn more"),ya({group:y,tx:u-7,ty:Sa[h-1][0].y+fa/2,sx:l,sy:n,hFlip:!f,dr:s,marker:"marker"});let $=v.append("text").attr("x",r).attr("y",o).attr("class","annotation-text").style("dominant-baseline","hanging").style("text-anchor",f?"start":"end");$.append("tspan").style("dominant-baseline","hanging").text("Each input chanel"),$.append("tspan").attr("x",e).attr("dy","1em").style("dominant-baseline","hanging").text("gets a different kernel"),$.append("tspan").attr("x",e).attr("dy","1.3em").style("font-weight",700).style("dominant-baseline","hanging").text("Hover over "),$.append("tspan").style("font-weight",400).style("dominant-baseline","hanging").text("to see value!"),ya({group:y,tx:g,ty:p,sx:i,sy:d,dr:c,hFlip:!f,marker:"marker"});let w=y.append("g").attr("class","plus-annotation"),k=u+2*fa+2.5*m,I=k,L=Sa[h][x].y+fa+3*$a;0===x&&(I+=30),9===x&&(I=k+xa-10,L-=2.5*fa);let M=w.append("text").attr("x",I).attr("y",L).attr("class","annotation-text").style("dominant-baseline","hanging").style("text-anchor","start");M.append("tspan").style("dominant-baseline","hanging").text("Add up all intermediate"),M.append("tspan").attr("x",I).attr("dy","1em").style("dominant-baseline","hanging").text("results and then add bias"),ya(9===x?{group:y,sx:k+50,sy:Sa[h][x].y-(fa/2+2*$a),tx:k+2*xa+5,ty:Sa[h][x].y+fa/2-xa,dr:50,hFlip:!1,marker:"marker-alt"}:{group:y,sx:k+35,sy:Sa[h][x].y+fa+2*$a,tx:k+2*xa+5,ty:Sa[h][x].y+fa/2+xa,dr:30,hFlip:!0,marker:"marker-alt"});let A=Sa[h][x].y;0===x?A+=fa+3*$a:A-=2*$a+5,w.append("text").attr("class","annotation-text").attr("x",k+xa).attr("y",A).style("text-anchor","middle").style("dominant-baseline",0===x?"hanging":"baseline").text("Bias")},Va=(t,e,a,l,n,s,r,o)=>{let i=Aa.select("g.underneath");for(let d=0;d<Ca[t-1].length;d++)i.append("rect").attr("class","underneath-gateway").attr("id","underneath-gateway-"+d).attr("x",a-n).attr("y",Sa[t-1][d].y-n).attr("width",2*fa+l+2*n).attr("height",fa+2*n).attr("rx",10).style("fill","rgba(160, 160, 160, 0.2)").style("opacity",0),Aa.select(`g#layer-${t-1}-node-${d}`).style("pointer-events","all").style("cursor","pointer").on("mouseover",s).on("mouseleave",r).on("click",(a,l,n)=>o(a,l,n,e,t));i.lower()},Da=(t,e,a,l,n)=>{Aa.select(".intermediate-layer-overlay").empty()&&Aa.append("g").attr("class","intermediate-layer-overlay"),Aa.select(".intermediate-layer-overlay").append("rect").attr("class","overlay").style("fill",`url(#${t})`).style("stroke","none").attr("width",l).attr("height",n).attr("x",e).attr("y",a).style("opacity",0).transition("move").duration(800).ease(d3.easeCubicInOut).style("opacity",1)},Wa=(t,e)=>{let a=Na[_a][t-1],l=Na[_a][t],n=Math.max(a,l);a>l?(Aa.select(`g#layer-${t}-node-${e}`).select("image.node-image").each((t,e,a)=>ta(t,e,a,n)),za=[t,e],ot.set(za)):a<l&&(Aa.select("g#cnn-layer-group-"+(t-1)).selectAll("image.node-image").each((t,e,a)=>ta(t,e,a,n)),za=[t-1,void 0],ot.set(za));let s=Ha[t-1].min,r=Ha[t-1].max,o=Ca[t][e];for(let t=0;t<o.output.length;t++)for(let e=0;e<o.output[0].length;e++)o.output[t][e]<s&&(s=o.output[t][e]),o.output[t][e]>r&&(r=o.output[t][e]);return{range:n,minMax:{min:s,max:r}}},Ka=(t,e,a,l,n,s,r,o)=>{let i=Sa[t-1][0].x+2*fa+2*Ra*ka+2*xa,d=Ra*ka*2/3,c=Sa[t-1][0].x;Oa.conv_1_1=i+fa,yt.set(Oa),Aa.select("g.edge-group").style("visibility","hidden"),pa({layerIndex:t,targetX:i,disable:!0,delay:0,opacity:.15,specialIndex:a});let g=i+fa+Ra*ka,p=(l-g-10*fa)/10;for(let e=t+1;e<va;e++){pa({layerIndex:e,targetX:g+(e-(t+1))*(fa+p),disable:!0,delay:0})}ua("overlay-gradient",[{offset:"0%",color:"rgb(250, 250, 250)",opacity:.85},{offset:"50%",color:"rgb(250, 250, 250)",opacity:.95},{offset:"100%",color:"rgb(250, 250, 250)",opacity:1}]),Da("overlay-gradient",g-Ia/2,0,l-g+Ia,n+wa.top+wa.bottom);let{intermediateLayer:u,intermediateMinMax:h,kernelRange:y,kernelMinMax:m}=qa(t,c,i,g,d,e,a,s,r,o);Va(t,a,c,d,8,s,r,o);let f=1/0,x=-1/0,v=Ca[t][a];for(let t=0;t<v.output.length;t++)for(let e=0;e<v.output[0].length;e++)v.output[t][e]<f&&(f=v.output[t][e]),v.output[t][e]>x&&(x=v.output[t][e]);let b={min:Math.min(f,h.min),max:Math.max(x,h.max)},$=Aa.append("g").attr("class","intermediate-layer-annotation").style("opacity",0);ja({leftX:c,curLayerIndex:t,group:$,intermediateGap:d,isFirstConv:!0,i:a});let w=Na.local[t];ha({legendHeight:5,curLayerIndex:t,range:1,group:u,width:2*fa+d,isInput:!0,x:c,y:wa.top+10*Ea+Ea+10*fa-25}),ha({legendHeight:5,curLayerIndex:t,range:w,minMax:b,group:u,width:2*fa+d,x:Sa[t-1][2].x,y:wa.top+10*Ea+Ea+10*fa}),ha({legendHeight:5,curLayerIndex:t,range:y,minMax:m,group:u,width:2*fa+d,x:i+fa-(2*fa+d),y:wa.top+10*Ea+Ea+10*fa,gradientAppendingName:"kernelColorGradient",colorScale:ma.weight,gradientGap:.2}),Aa.selectAll("g.intermediate-layer, g.intermediate-layer-annotation").transition().delay(500).duration(500).ease(d3.easeCubicInOut).style("opacity",1)},Ya=(t,e,a,l,n,s,r,o)=>{let i=Sa[t-1][0].x+2*fa+2*Ra*ka+2*xa,d=Ra*ka*2/3;Oa.conv_1_2=i+fa,yt.set(Oa);let{range:c,minMax:g}=Wa(t,a);Aa.select("g.edge-group").style("visibility","hidden"),pa({layerIndex:t,targetX:i,disable:!0,delay:0,opacity:.15,specialIndex:a});let p=i+fa+Ra*ka,u=(l-p-8*fa)/8;for(let e=t+1;e<va;e++){pa({layerIndex:e,targetX:p+(e-(t+1))*(fa+u),disable:!0,delay:0})}let h=[{offset:"0%",color:"rgb(250, 250, 250)",opacity:.85},{offset:"50%",color:"rgb(250, 250, 250)",opacity:.95},{offset:"100%",color:"rgb(250, 250, 250)",opacity:1}];ua("overlay-gradient-right",h),h=[{offset:"0%",color:"rgb(250, 250, 250)",opacity:.85+(.95-.85)*((2*fa+Ra*ka)/(8*fa+7*d))},{offset:"100%",color:"rgb(250, 250, 250)",opacity:.85}],ua("overlay-gradient-left",h),Da("overlay-gradient-right",p-Ia/2,0,l-p+Ia,n+wa.top+wa.bottom),Da("overlay-gradient-left",Sa[0][0].x-Ia/2,0,2*fa+Ra*ka+Ia,n+wa.top+wa.bottom);let y=Sa[t-1][0].x,{intermediateLayer:m,intermediateMinMax:f,kernelRange:x,kernelMinMax:v}=qa(t,y,i,p,d,e,a,s,r,o);Va(t,a,y,d,5,s,r,o);let b={min:Math.min(g.min,f.min),max:Math.max(g.max,f.max)},$=Aa.append("g").attr("class","intermediate-layer-annotation").style("opacity",0);ja({leftX:y,curLayerIndex:t,group:$,intermediateGap:d,i:a}),ha({legendHeight:5,curLayerIndex:t,range:c,minMax:b,group:m,width:2*fa+d,x:y,y:wa.top+10*Ea+Ea+10*fa}),ha({legendHeight:5,curLayerIndex:t,range:x,minMax:v,group:m,width:2*fa+d,x:i+fa-(2*fa+d),y:wa.top+10*Ea+Ea+10*fa,gradientAppendingName:"kernelColorGradient",colorScale:ma.weight,gradientGap:.2}),Aa.selectAll("g.intermediate-layer, g.intermediate-layer-annotation").transition().delay(500).duration(500).ease(d3.easeCubicInOut).style("opacity",1)},Ua=(t,e,a,l,n,s,r,o)=>{let i=Sa[t][0].x,d=i-(2*fa+2*Ra*ka+2*xa),c=Ra*ka*2/3;Oa.conv_2_1=i+fa,yt.set(Oa),Aa.select("g.edge-group").style("visibility","hidden");let{range:g,minMax:p}=Wa(t,a);pa({layerIndex:t-1,targetX:d,disable:!0,delay:0}),pa({layerIndex:t,targetX:i,disable:!0,delay:0,opacity:.15,specialIndex:a});let u=d-Ra,h=(u-Sa[0][0].x-5*fa)/5,y=Sa[t][0].x+fa+Ra;for(let e=0;e<t-1;e++){let t=Sa[0][0].x+e*(fa+h);pa({layerIndex:e,targetX:t,disable:!0,delay:0})}let m=[{offset:"0%",color:"rgb(250, 250, 250)",opacity:1},{offset:"50%",color:"rgb(250, 250, 250)",opacity:.9},{offset:"100%",color:"rgb(250, 250, 250)",opacity:.85}];ua("overlay-gradient-left",m),m=[{offset:"0%",color:"rgb(250, 250, 250)",opacity:.85},{offset:"50%",color:"rgb(250, 250, 250)",opacity:.95},{offset:"100%",color:"rgb(250, 250, 250)",opacity:1}],ua("overlay-gradient-right",m),Da("overlay-gradient-left",Sa[0][0].x-Ia/2,0,u-Sa[0][0].x+Ia,n+wa.top+wa.bottom),Da("overlay-gradient-right",y-Ia/2,0,l-y+Ia,n+wa.top+wa.bottom);let{intermediateLayer:f,intermediateMinMax:x,kernelRange:v,kernelMinMax:b}=qa(t,d,Sa[t][0].x,y,c,e,a,s,r,o);Va(t,a,d,c,5,s,r,o);let $={min:Math.min(p.min,x.min),max:Math.max(p.max,x.max)},w=Aa.append("g").attr("class","intermediate-layer-annotation").style("opacity",0);ja({leftX:d,curLayerIndex:t,group:w,intermediateGap:c,i:a}),ha({legendHeight:5,curLayerIndex:t,range:g,group:f,width:2*fa+c,minMax:$,x:d,y:wa.top+10*Ea+Ea+10*fa}),ha({legendHeight:5,curLayerIndex:t,range:v,minMax:b,group:f,width:2*fa+c,x:i+fa-(2*fa+c),y:wa.top+10*Ea+Ea+10*fa,gradientAppendingName:"kernelColorGradient",colorScale:ma.weight,gradientGap:.2}),Aa.selectAll("g.intermediate-layer, g.intermediate-layer-annotation").transition().delay(500).duration(500).ease(d3.easeCubicInOut).style("opacity",1)},Ja=(t,e,a,l,n,s,r,o)=>{let i=Sa[t][0].x,d=i-(2*fa+2*Ra*ka+2*xa),c=Ra*ka*2/3;Oa.conv_2_2=d,yt.set(Oa),Aa.select("g.edge-group").style("visibility","hidden");let{range:g,minMax:p}=Wa(t,a);pa({layerIndex:t-1,targetX:d,disable:!0,delay:0}),pa({layerIndex:t,targetX:i,disable:!0,delay:0,opacity:.15,specialIndex:a});let u=d-Ra,h=(u-Sa[0][0].x-7*fa)/7,y=i+fa+Ra;for(let e=0;e<t-1;e++){let t=Sa[0][0].x+e*(fa+h);pa({layerIndex:e,targetX:t,disable:!0,delay:0})}let m=[{offset:"0%",color:"rgb(250, 250, 250)",opacity:1},{offset:"50%",color:"rgb(250, 250, 250)",opacity:.95},{offset:"100%",color:"rgb(250, 250, 250)",opacity:.85}];ua("overlay-gradient-left",m),m=[{offset:"0%",color:"rgb(250, 250, 250)",opacity:.85},{offset:"50%",color:"rgb(250, 250, 250)",opacity:.95},{offset:"100%",color:"rgb(250, 250, 250)",opacity:1}],ua("overlay-gradient-right",m),Da("overlay-gradient-left",Sa[0][0].x-Ia/2,0,u-Sa[0][0].x+Ia,n+wa.top+wa.bottom),Da("overlay-gradient-right",y-Ia/2,0,l-y+Ia,n+wa.top+wa.bottom);let{intermediateLayer:f,intermediateMinMax:x,kernelRange:v,kernelMinMax:b}=qa(t,d,Sa[t][0].x,y,c,e,a,s,r,o);Va(t,a,d,c,5,s,r,o);let $={min:Math.min(p.min,x.min),max:Math.max(p.max,x.max)},w=Aa.append("g").attr("class","intermediate-layer-annotation").style("opacity",0);ja({leftX:d,curLayerIndex:t,group:w,intermediateGap:c,i:a}),ha({legendHeight:5,curLayerIndex:t,range:g,group:f,minMax:$,width:2*fa+c,x:d,y:wa.top+10*Ea+Ea+10*fa}),ha({legendHeight:5,curLayerIndex:t,range:v,minMax:b,group:f,width:2*fa+c,x:i+fa-(2*fa+c),y:wa.top+10*Ea+Ea+10*fa,gradientAppendingName:"kernelColorGradient",colorScale:ma.weight,gradientGap:.2}),Aa.selectAll("g.intermediate-layer, g.intermediate-layer-annotation").transition().delay(500).duration(500).ease(d3.easeCubicInOut).style("opacity",1)},Qa=Re.layerColorScales,Za=Re.nodeLength,tl=Re.plusSymbolRadius,el=Re.intermediateColor,al=Re.kernelRectLength,ll=Re.svgPaddings,nl=Re.gapRatio,sl=Re.classLists,rl=d3.format(".4f");let ol=void 0;tt.subscribe(t=>{ol=t});let il=void 0;et.subscribe(t=>{il=t});let dl=void 0;at.subscribe(t=>{dl=t});let cl=void 0;Z.subscribe(t=>{cl=t});let gl=void 0;lt.subscribe(t=>{gl=t});let pl=void 0;nt.subscribe(t=>{pl=t});let ul=void 0;st.subscribe(t=>{ul=t});let hl=void 0;rt.subscribe(t=>{hl=t});let yl=void 0;ct.subscribe(t=>{yl=t});let ml=void 0;pt.subscribe(t=>{ml=t});let fl=void 0;gt.subscribe(t=>{fl=t});let xl=void 0;ut.subscribe(t=>{xl=t});let vl=void 0;it.subscribe(t=>{vl=t});let bl=10,$l=11,wl=!1,kl=[],Il={};const Ll=(t,e,a,l,n,s)=>{let r=d3.select(a[e]);if(s){let t=+r.attr("data-preX"),e=+r.attr("data-preY");r.transition("softmax").duration(n).ease(d3.easeCubicInOut).attr("transform",`translate(${t}, ${e})`)}else{let t=r.attr("transform"),e=+t.replace(/.*\(([\d\.]+),.*/,"$1"),a=+t.replace(/.*,\s([\d\.]+)\)/,"$1");r.transition("softmax").duration(n).ease(d3.easeCubicInOut).attr("transform",`translate(${e-l}, ${a})`),r.attr("data-preX",e),r.attr("data-preY",a)}},Ml=t=>{ut.set({show:!0,text:"Logit: "+rl(kl[t])}),fl.highlightI=t,gt.set(fl);let e=ol.select(".logit-layer"),a=ol.select(".underneath"),l=ol.select(".intermediate-layer");e.select("#logit-circle-"+t).style("stroke-width",2),l.select("#plus-symbol-clone-"+t).style("opacity",1).select("circle").style("fill",t=>t.fill),a.select("#logit-lower-"+t).raise(),a.selectAll(".softmax-abstract-edge-"+t).style("stroke-width",.8).style("stroke","#E0E0E0"),a.selectAll(".softmax-edge-"+t).style("stroke-width",1).style("stroke","#E0E0E0"),a.selectAll(".logit-output-edge-"+t).style("stroke-width",3).style("stroke","#E0E0E0"),e.selectAll(".logit-output-edge-"+t).style("stroke-width",3).style("stroke","#E0E0E0")},Al=t=>{ut.set({show:!1,text:"Logit: "+rl(kl[t])}),fl.highlightI=-1,gt.set(fl);let e=ol.select(".logit-layer"),a=ol.select(".underneath"),l=ol.select(".intermediate-layer");e.select("#logit-circle-"+t).style("stroke-width",1),l.select("#plus-symbol-clone-"+t).style("opacity",.2),a.selectAll(".softmax-abstract-edge-"+t).style("stroke-width",.2).style("stroke","#EDEDED"),a.selectAll(".softmax-edge-"+t).style("stroke-width",.2).style("stroke","#F1F1F1"),a.selectAll(".logit-output-edge-"+t).style("stroke-width",1.2).style("stroke","#E5E5E5"),e.selectAll(".logit-output-edge-"+t).style("stroke-width",1.2).style("stroke","#E5E5E5")},El=t=>{Ml(t.detail.curI)},Rl=t=>{Al(t.detail.curI)},Cl=t=>{let e=t.curLayerIndex,a=t.moveX,l=t.symbolX,n=t.symbolY,s=t.outputX,r=t.outputY,o=t.softmaxLeftMid,i=t.selectedI,d=t.intermediateX1,c=t.intermediateX2,g=t.pixelWidth,p=t.pixelHeight,u=t.topY,h=t.bottomY,y=t.middleGap,m=t.middleRectHeight,f=t.softmaxX,x=t.softmaxTextY,v=t.softmaxWidth,b=t.symbolGroup,$=t.flattenRange,w=o-4*a/5;d3.event.stopPropagation(),yl?(pt.set(!1),ol.select(".logit-layer").remove(),ol.select(".logit-layer-lower").remove(),ol.selectAll(".plus-symbol-clone").remove(),ol.select(".underneath").selectAll(".logit-lower").style("opacity",0),gt.set({show:!1,logits:[]})):pt.set(!0),ol.select(".intermediate-layer-overlay").select("rect.overlay").transition("softmax").ease(d3.easeCubicInOut).duration(600).attr("transform",`translate(${yl?0:-a}, 0)`),ol.selectAll(".intermediate-legend-"+(e-1)).each((t,e,l)=>Ll(0,e,l,a,600,yl)),ol.select(".intermediate-layer").select(".layer-label").each((t,e,l)=>Ll(0,e,l,a,600,yl)),ol.select(".intermediate-layer").select(".layer-detailed-label").each((t,e,l)=>Ll(0,e,l,a,600,yl));for(let t=e-1;t>=0;t--){let e=+ol.select("g#cnn-layer-group-"+t).select("image").attr("x");pa({layerIndex:t,targetX:yl?e+a:e-a,disable:!0,delay:0,transitionName:"softmax",duration:600})}ol.select(".plus-annotation").transition("softmax").duration(600).style("opacity",yl?1:0).style("pointer-events",yl?"all":"none");let k=ol.select(".softmax-annotation").style("pointer-events",yl?"all":"none"),I=k.selectAll(".softmax-detail-annoataion").data([0]).enter().append("g").attr("class","softmax-detail-annoataion");yl&&k.selectAll(".softmax-detail-annoataion").remove(),k.select(".arrow-group").transition("softmax").duration(600).style("opacity",yl?1:0),k.select(".annotation-text").style("cursor","help").style("pointer-events","all").on("click",()=>{d3.event.stopPropagation(),document.querySelector("#article-softmax").scrollIntoView({behavior:"smooth"})}).transition("softmax").duration(600).style("opacity",yl?1:0).on("end",()=>{if(!yl){let t=f+v/2,a=x-10;0===i&&(a=x+70);let l=I.append("text").attr("x",t).attr("y",a).attr("class","annotation-text softmax-detail-text").style("dominant-baseline","baseline").style("text-anchor","middle").text("Normalize ");l.append("tspan").attr("dx",1).style("fill","#E56014").text("logits"),l.append("tspan").attr("dx",1).text(" into"),l.append("tspan").attr("x",t).attr("dy","1.1em").text("class probabilities"),ya(0===i?{group:I,sx:f+v/2-5,sy:x+44,tx:f+v/2,ty:a-12,dr:50,hFlip:!0,marker:"marker-alt"}:{group:I,sx:f+v/2-5,sy:x+4,tx:f+v/2,ty:n-tl-4,dr:50,hFlip:!0,marker:"marker-alt"}),t=w+45,a=(ll.top+il)/2+5;let s=w+20,r=(ll.top+il)/2+5;I.append("g").attr("class","layer-detailed-label").attr("transform",()=>`translate(${w}, ${(ll.top+il)/2-5})`).classed("hidden",!vl).append("text").style("opacity",.7).style("dominant-baseline","middle").style("font-size","12px").style("font-weight","800").append("tspan").attr("x",0).text("logit").append("tspan").attr("x",0).style("font-size","8px").style("font-weight","normal").attr("dy","1.5em").text("(10)"),I.append("text").attr("class","annotation-text").attr("x",t).attr("y",(ll.top+il)/2+3).style("text-anchor","start").text("Before").append("tspan").attr("x",t).attr("dy","1em").text("normalization"),ya({group:I,tx:s,ty:r,sx:t-6,sy:a+2,dr:60,hFlip:!1,marker:"marker-alt"}),I.append("text").attr("class","annotation-text").attr("x",gl[$l][0].x-35).attr("y",(ll.top+il)/2+3).style("text-anchor","end").text("After").append("tspan").attr("x",gl[$l][0].x-35).attr("dy","1em").text("normalization"),ya({group:I,tx:gl[$l][0].x-8,ty:r,sx:gl[$l][0].x-27,sy:a+2,dr:60,hFlip:!0,marker:"marker-alt"});for(let t=0;t<10;t++)I.append("text").attr("x",w).attr("y",gl[e-1][t].y+Za/2+8).attr("class","annotation-text softmax-detail-text").attr("id","logit-text-"+t).style("text-anchor","middle").style("dominant-baseline","hanging").style("opacity",0).text(""+sl[t]);let o=I.append("g").attr("class","softmax-detail-hover-annotation").style("opacity",0);t=w+50,a=gl[e-1][0].y+Za/2,i<3&&(a=gl[e-1][9].y+Za/2);let d=o.append("text").attr("x",t).attr("y",a).attr("class","annotation-text softmax-detail-text softmax-hover-text").style("text-anchor","start").style("dominant-baseline","baseline").append("tspan").style("font-weight",700).style("dominant-baseline","baseline").text("Hover over ").append("tspan").style("font-weight",400).style("dominant-baseline","baseline").text("to see");d.append("tspan").style("dominant-baseline","baseline").attr("x",t).attr("dy","1em").text("its "),d.append("tspan").style("dominant-baseline","baseline").attr("dx",1).style("fill","#E56014").text("logit"),d.append("tspan").style("dominant-baseline","baseline").attr("dx",1).text(" value"),ya({group:o,tx:w+15,ty:a,sx:t-8,sy:a+2,dr:60,hFlip:!1})}}),ol.select(".flatten-annotation").transition("softmax").duration(600).style("opacity",yl?1:0).style("pointer-events",yl?"all":"none");let L=ol.select(".flatten-layer-left");L.transition("softmax").duration(600).ease(d3.easeCubicInOut).attr("transform",`translate(${yl?0:-a}, 0)`).on("end",()=>{if(!yl){(t=>{let e=t.curLayerIndex,a=t.moveX,l=t.softmaxLeftMid,n=t.selectedI,s=t.intermediateX1,r=t.intermediateX2,o=t.pixelWidth,i=t.pixelHeight,d=t.topY,c=t.bottomY,g=t.softmaxX,p=t.middleGap,u=t.middleRectHeight,h=t.symbolGroup,y=t.symbolX,m=t.flattenRange,f=ol.select(".intermediate-layer").append("g").attr("class","logit-layer").raise(),x=ol.select(".intermediate-layer").select(".flatten-layer").select(".plus-symbol").clone(!0).attr("class","temp-clone-plus-symbol").attr("transform",`translate(${y-a},\n      ${gl[e][n].y+Za/2})`).style("pointer-events","none").remove(),v=f.append(()=>x.node());ol.select(".softmax-symbol").raise();let b=ol.select(".underneath").append("g").attr("class","logit-layer-lower").lower(),$=l-4*a/5;kl=[];for(let t=0;t<cl[$l].length;t++)kl.push(cl[$l][t].logit);let w=d3.scaleLinear().domain(d3.extent(kl)).range([.2,1]);f.append("circle").attr("class","logit-circle").attr("id","logit-circle-"+n).attr("cx",$).attr("cy",gl[e-1][n].y+Za/2).attr("r",8).style("fill",Qa.logit(w(kl[n]))).style("cursor","crosshair").style("pointer-events","all").style("stroke",el).on("mouseover",()=>Ml(n)).on("mouseleave",()=>Al(n)).on("click",()=>{d3.event.stopPropagation()});let k=ol.select(".intermediate-layer-annotation").select(".softmax-detail-annoataion");k.select("#logit-text-"+n).style("opacity",1),v.raise(),f.append("line").attr("class","logit-output-edge-"+n).attr("x1",r-a+2*tl).attr("x2",g).attr("y1",gl[e-1][n].y+Za/2).attr("y2",gl[e-1][n].y+Za/2).style("fill","none").style("stroke","#EAEAEA").style("stroke-width","1.2").lower();let I=[],L=cl.flatten.length/cl[1].length,M=[...Array(cl[$l].length).keys()].filter(t=>t!=n),A=0,E=d3.linkHorizontal().x(t=>t.x).y(t=>t.y);const R=()=>{if(!ml)return void ol.select(".underneath").selectAll(".logit-lower").remove();let t=M[A],l=ol.select(".underneath").select("#logit-lower-"+t);if(l.empty()){l=ol.select(".underneath").append("g").attr("class","logit-lower").attr("id","logit-lower-"+t).style("opacity",0);for(let l=0;l<L;l+=3){[0,9].forEach(n=>{let g=l+n*L;I.push({source:{x:s+o+3-a,y:0===n?d+l*i:c+l*i},target:{x:r-a,y:gl[e][t].y+Za/2},index:g,weight:cl.flatten[g].outputLinks[t].weight,color:"#F1F1F1",width:.5,opacity:1,class:"softmax-edge-"+t})})}for(let l=0;l<cl[$l].length-2;l++)I.push({source:{x:s+o+3-a,y:d+L*i+p*(l+1)+u*(l+.5)},target:{x:r-a,y:gl[e][t].y+Za/2},index:-1,color:"#EDEDED",width:.5,opacity:1,class:"softmax-abstract-edge-"+t});l.selectAll("path.softmax-edge-"+t).data(I).enter().append("path").attr("class",t=>t.class).attr("id",t=>"edge-"+t.name).attr("d",t=>E({source:t.source,target:t.target})).style("fill","none").style("stroke-width",t=>t.width).style("stroke",t=>void 0===t.color?el:t.color).style("opacity",t=>t.opacity).style("pointer-events","none")}let x=f.append("g").attr("class","logit-layer-"+t).style("opacity",0),v=h.clone(!0).style("opacity",0);v.attr("class","plus-symbol-clone").attr("id","plus-symbol-clone-"+t).select("circle").datum({fill:He(Qa.weight,m,cl[$l][t].bias,.35)}).style("pointer-events","none").style("fill","#E5E5E5"),v.attr("transform",`translate(${y},\n      ${gl[e][t].y+Za/2})`);let C=E({source:{x:r-a+2*tl,y:gl[e][t].y+Za/2},target:{x:$+8,y:gl[e][t].y+Za/2}}),S=E({source:{x:$+8,y:gl[e][t].y+Za/2},target:{x:g,y:gl[e][n].y+Za/2}}),_=b.append("path").attr("class","logit-output-edge-"+t).attr("d",C).style("fill","none").style("stroke","#EAEAEA").style("stroke-width","1.2"),N=b.append("path").attr("class","logit-output-edge-"+t).attr("d",S).style("fill","none").style("stroke","#EAEAEA").style("stroke-width","1.2"),H=_.node().getTotalLength(),z=N.node().getTotalLength(),P=H+z,B=wl?500:800,O=wl?400:600;_.attr("stroke-dasharray",H+" "+H).attr("stroke-dashoffset",H),N.attr("stroke-dasharray",z+" "+z).attr("stroke-dashoffset",z),_.transition("softmax-output-edge").duration(H/P*B).attr("stroke-dashoffset",0),N.transition("softmax-output-edge").delay(H/P*B).duration(z/P*B).attr("stroke-dashoffset",0),x.append("circle").attr("class","logit-circle").attr("id","logit-circle-"+t).attr("cx",$).attr("cy",gl[e-1][t].y+Za/2).attr("r",7).style("fill",Qa.logit(w(kl[t]))).style("stroke",el).style("cursor","crosshair").on("mouseover",()=>Ml(t)).on("mouseleave",()=>Al(t)).on("click",()=>{d3.event.stopPropagation()}),fl.startAnimation={i:t,duration:O,hasInitialized:!1},gt.set(fl),x.transition("softmax-edge").duration(O).style("opacity",1),(n<3&&9==t||n>=3&&0==t)&&k.select(".softmax-detail-hover-annotation").transition("softmax-edge").duration(O).style("opacity",1),k.select("#logit-text-"+t).transition("softmax-edge").duration(O).style("opacity",1),l.transition("softmax-edge").duration(O).style("opacity",1).on("end",()=>{A++,A<M.length?(I=[],R()):(wl=!0,fl.hasInitialized=!0,gt.set(fl))}),v.transition("softmax-edge").duration(O).style("opacity",.2)};let C=ol.select(".intermediate-layer").select(".layer-label").node(),S=((t,e)=>{if(void 0!==t){let a=e;for(;null==a.getScreenCTM&&null!=a.parentNode;)a=a.parentNode;let l=t.node().ownerSVGElement.createSVGPoint(),n=a.getScreenCTM(),s=a.getBBox().height;l.x+=0,l.y-=s/2;let r=l.matrixTransform(n);return{top:r.y,left:r.x}}})(ol,C),_=100+ +d3.select("#cnn-svg").style("height").replace("px","")/2-96;const N=document.getElementById("detailview");N.style.top=_+"px",N.style.left=S.left-490-50+"px",N.style.position="absolute",gt.set({show:!0,logits:kl,logitColors:kl.map(t=>Qa.logit(w(t))),selectedI:n,highlightI:-1,outputName:sl[n],outputValue:cl[$l][n].output,startAnimation:{i:-1,duration:0,hasInitialized:wl}}),R(),ha({legendHeight:5,curLayerIndex:e,range:d3.extent(kl)[1]-d3.extent(kl)[0],minMax:{min:d3.extent(kl)[0],max:d3.extent(kl)[1]},group:f,width:g-(r+2*tl-a+5),gradientAppendingName:"flatten-logit-gradient",gradientGap:.1,colorScale:Qa.logit,x:r+2*tl-a+5,y:ll.top+10*il+il+10*Za}),f.append("g").attr("class","layer-label").classed("hidden",vl).attr("transform",()=>`translate(${$}, ${(ll.top+il)/2+5})`).append("text").style("text-anchor","middle").style("dominant-baseline","middle").style("opacity",.8).style("font-weight",800).text("logit")})({curLayerIndex:e,moveX:a,softmaxLeftMid:o,selectedI:i,intermediateX1:d,intermediateX2:c,pixelWidth:g,pixelHeight:p,topY:u,bottomY:h,middleGap:y,middleRectHeight:m,softmaxX:f,symbolGroup:b,symbolX:l,flattenRange:$})}if(yl)L.select(".symbol-output-line").remove();else{L.select(".edge-group").append("line").attr("class","symbol-output-line").attr("x1",l).attr("y1",n).attr("x2",s+a).attr("y2",r).style("stroke-width",1.2).style("stroke","#E5E5E5").style("opacity",0).transition("softmax").delay(200).duration(400).style("opacity",1)}yl=!yl,ct.set(yl)})},Sl=(t,e,a,l,n)=>{ol.selectAll(".output-legend").classed("hidden",!1);let s=Za/2,r=2*Za+5.5*dl*nl+s,o=gl[t][0].x-r,i=dl*nl*4/2;let d=d3.linkHorizontal().x(t=>t.x).y(t=>t.y);ol.select("g.edge-group").style("visibility","hidden"),pa({layerIndex:t-1,targetX:o,disable:!0,delay:0}),pa({layerIndex:t,targetX:gl[t][0].x,disable:!0,delay:0,opacity:.15,specialIndex:a});let c=(o-dl-gl[0][0].x-10*Za)/10;if(c>20)for(let e=0;e<t-1;e++){let t=gl[0][0].x+e*(Za+c);pa({layerIndex:e,targetX:t,disable:!0,delay:0})}else{c=20;let e=o-2*c-Za;for(let a=t-2;a>=0;a--)pa({layerIndex:a,targetX:e,disable:!0,delay:0}),e=e-c-Za}ua("overlay-gradient-left",[{offset:"0%",color:"rgb(250, 250, 250)",opacity:1},{offset:"50%",color:"rgb(250, 250, 250)",opacity:.95},{offset:"100%",color:"rgb(250, 250, 250)",opacity:.85}]);let g=ol.append("g").attr("class","intermediate-layer-overlay");g.append("rect").attr("class","overlay").style("fill","url(#overlay-gradient-left)").style("stroke","none").attr("width",o+ll.left-2*c+3).attr("height",n+ll.top+ll.bottom).attr("x",-ll.left).attr("y",0).style("opacity",0),g.selectAll("rect.overlay").transition("move").duration(800).ease(d3.easeCubicInOut).style("opacity",1);let p=ol.append("g").attr("class","intermediate-layer").style("opacity",0),u=o+Za+i,h=u+i+s,y=ul[pl][t-1],m=Qa.conv,f=cl.flatten.length/cl[1].length,x=[],v=p.append("g").attr("class","flatten-layer").append("g").attr("class","flatten-layer-left"),b=gl[t-1][0].y,$=gl[t-1][9].y+Za-1.1*f,w=cl[t-1][0].output.length,k=Za/(2*w),I=Za/w,L=d3.extent(cl.flatten.slice(f).map(t=>t.outputLinks[a].weight).concat(cl.flatten.slice(9*f,10*f).map(t=>t.outputLinks[a].weight))),M=Math.round(1e3*Math.max(...L.map(Math.abs)))/1e3*2,A=t=>{let e=t.index;xl=void 0===t.weight?{show:!0,text:"Pixel value: "+rl(Il[e])}:{show:!0,text:"Weight: "+rl(t.weight)},ut.set(xl),v.select("#edge-flatten-"+e).raise().style("stroke",el).style("stroke-width",1),v.select(`#edge-flatten-${e}-output`).raise().style("stroke-width",1).style("stroke",t=>He(Qa.weight,M,t.weight,.1)),v.select("#bounding-"+e).raise().style("opacity",1)},E=t=>{let e=t.index;xl=void 0===t.weight?{show:!1,text:"Pixel value: "+rl(Il[e])}:{show:!1,text:"Weight: "+rl(t.weight)},ut.set(xl),v.select("#edge-flatten-"+e).style("stroke-width",.6).style("stroke","#E5E5E5"),v.select(`#edge-flatten-${e}-output`).style("stroke-width",.6).style("stroke",t=>He(Qa.weight,M,t.weight,.35)),v.select("#bounding-"+e).raise().style("opacity",0)};Il={};for(let e=0;e<f;e++){[0,9].forEach(l=>{let n=e+l*f;Il[n]=cl.flatten[n].output,v.append("rect").attr("x",u).attr("y",0===l?b+1.1*e:$+1.1*e).attr("width",s).attr("height",1.1).style("cursor","crosshair").style("fill",m((cl.flatten[n].output+y/2)/y)).on("mouseover",()=>A({index:n})).on("mouseleave",()=>E({index:n})).on("click",()=>{d3.event.stopPropagation()}),x.push({source:{x:u+s+3,y:0===l?b+1.1*e:$+1.1*e},target:{x:h,y:gl[t][a].y+Za/2},index:n,weight:cl.flatten[n].outputLinks[a].weight,name:`flatten-${n}-output`,color:He(Qa.weight,M,cl.flatten[n].outputLinks[a].weight,.35),width:.6,opacity:1,class:"flatten-output"});let r=Math.floor(e/w);x.push({target:{x:u-3,y:0===l?b+1.1*e:$+1.1*e},source:{x:o+Za+3,y:gl[t-1][l].y+(2*r+1)*k},index:n,name:"flatten-"+n,color:"#E5E5E5",width:.6,opacity:1,class:"flatten"});let i=cl.flatten[n].inputLinks[0].weight;v.append("rect").attr("id","bounding-"+n).attr("class","flatten-bounding").attr("x",o+i[1]*I).attr("y",gl[t-1][l].y+i[0]*I).attr("width",I).attr("height",I).style("fill","none").style("stroke",el).style("stroke-length","0.5").style("pointer-events","all").style("cursor","crosshair").style("opacity",0).on("mouseover",()=>A({index:n})).on("mouseleave",()=>E({index:n})).on("click",()=>{d3.event.stopPropagation()})})}let R=[];for(let e=1;e<cl[t-1].length-1;e++)R.push({index:e});let C=(10*Za+9*il-1.1*f*2-45)/8;R.forEach((e,l)=>{v.append("rect").attr("x",u+s/4).attr("y",b+1.1*f+5*(l+1)+C*l).attr("width",s/2).attr("height",C).style("fill","#E5E5E5"),v.append("polyline").attr("points",`${o+Za+3}\n        ${gl[t-1][e.index].y},\n        ${o+Za+10}\n        ${gl[t-1][e.index].y+Za/2},\n        ${o+Za+3}\n        ${gl[t-1][e.index].y+Za}`).style("fill","#E5E5E5").style("opacity",1),x.push({source:{x:o+Za+10,y:gl[t-1][e.index].y+Za/2},target:{x:u-3,y:b+1.1*f+5*(l+1)+C*(l+.5)},index:-1,width:1,opacity:1,name:"flatten-abstract-"+e.index,color:"#E5E5E5",class:"flatten-abstract"}),x.push({source:{x:u+s+3,y:b+1.1*f+5*(l+1)+C*(l+.5)},target:{x:h,y:gl[t][a].y+Za/2},index:-1,name:`flatten-abstract-${e.index}-output`,color:"#E5E5E5",weight:e.weight,width:1,opacity:1,class:"flatten-abstract-output"})});let S=h+tl,_=gl[t][a].y+Za/2,N=v.append("g").attr("class","plus-symbol").attr("transform",`translate(${S}, ${_})`);N.append("rect").attr("x",-tl).attr("y",-tl).attr("width",2*tl).attr("height",2*tl).attr("rx",3).attr("ry",3).style("fill","none").style("stroke",el),N.append("rect").attr("x",-(tl-3)).attr("y",-.5).attr("width",2*(tl-3)).attr("height",1).style("fill",el),N.append("rect").attr("x",-.5).attr("y",-(tl-3)).attr("width",1).attr("height",2*(tl-3)).style("fill",el),N.append("circle").attr("cx",0).attr("cy",-Za/2-.5*al).attr("r",1.5*al).style("stroke",el).style("cursor","crosshair").style("fill",He(Qa.weight,M,e.bias,.35)).on("mouseover",()=>{ut.set({show:!0,text:"Bias: "+rl(e.bias)})}).on("mouseleave",()=>{ut.set({show:!1,text:"Bias: "+rl(e.bias)})}).on("click",()=>{d3.event.stopPropagation()}),N.append("path").attr("d",d({source:{x:0,y:0},target:{x:0,y:-Za/2-.5*al}})).attr("id","bias-plus").attr("stroke-width",1.2).attr("stroke","#E5E5E5").lower(),x.push({source:_e({x:h+2*tl-Za,y:gl[t][a].y}),target:Ne({x:gl[t][a].x-3,y:gl[t][a].y}),name:"symbol-output",width:1.2,color:"#E5E5E5"});let H=(r-2*Za-2*i-55)/2,z=h+2*tl,P=H+z,B=H/2+z,O=gl[t][a].y-2*al-6,X={curLayerIndex:t,moveX:2*(h-(u+s+3))/3,symbolX:S,symbolY:_,outputX:gl[t][a].x,outputY:_,softmaxLeftMid:B,selectedI:a,intermediateX1:u,intermediateX2:h,pixelWidth:s,pixelHeight:1.1,topY:b,bottomY:$,middleGap:5,middleRectHeight:C,softmaxX:P,softmaxWidth:55,softmaxTextY:O,symbolGroup:N,flattenRange:M},G=p.append("g").attr("class","softmax-symbol").attr("transform",`translate(${P}, ${_})`).style("pointer-event","all").style("cursor","pointer").on("click",()=>Cl(X));G.append("rect").attr("x",0).attr("y",-tl).attr("width",55).attr("height",2*tl).attr("stroke",el).attr("rx",2).attr("ry",2).attr("fill","#FAFAFA"),G.append("text").attr("x",5).attr("y",1).style("dominant-baseline","middle").style("font-size","12px").style("opacity",.5).text("softmax"),p.append("g").attr("class","layer-label").classed("hidden",vl).attr("transform",()=>`translate(${o+Za+(4*dl*nl+s)/2}, ${(ll.top+il)/2+5})`).style("cursor","help").on("click",()=>{d3.event.stopPropagation(),document.querySelector("#article-flatten").scrollIntoView({behavior:"smooth"})}).append("text").style("dominant-baseline","middle").style("opacity",.8).style("font-weight",800).text("flatten");let F=Number(d3.select("#cnn-svg").style("height").replace("px",""))+150,T=new SmoothScroll('a[href*="#"]',{offset:-F}),q=p.append("g").attr("transform",()=>`translate(${o+Za+(4*dl*nl+s)/2}, ${(ll.top+il)/2-5})`).attr("class","layer-detailed-label").classed("hidden",!vl).style("cursor","help").on("click",()=>{d3.event.stopPropagation();let t=document.querySelector("#article-flatten");T.animateScroll(t)});q.append("title").text("Move to article section");let j=q.append("text").style("text-anchor","middle").style("dominant-baseline","middle").style("opacity","0.7").style("font-weight",800).append("tspan").text("flatten"),V=cl[bl].length*cl[bl][0].output.length*cl[bl][0].output[0].length;j.append("tspan").attr("x",0).attr("dy","1.5em").style("font-size","8px").style("font-weight","normal").text(`(${V})`);let D=v.append("g").attr("class","edge-group").lower();D.selectAll("path").data(x).enter().append("path").attr("class",t=>t.class).attr("id",t=>"edge-"+t.name).attr("d",t=>d({source:t.source,target:t.target})).style("fill","none").style("stroke-width",t=>t.width).style("stroke",t=>void 0===t.color?el:t.color).style("opacity",t=>t.opacity),D.selectAll("path.flatten-abstract-output").lower(),D.selectAll("path.flatten,path.flatten-output").style("cursor","crosshair").style("pointer-events","all").on("mouseover",A).on("mouseleave",E).on("click",()=>{d3.event.stopPropagation()}),ha({legendHeight:5,curLayerIndex:t,range:y,minMax:hl[10],group:p,width:i+Za-3,x:o,y:ll.top+10*il+il+10*Za}),ha({legendHeight:5,curLayerIndex:t,range:M,minMax:{min:L[0],max:L[1]},group:p,width:i-3-5,gradientAppendingName:"flatten-weight-gradient",gradientGap:.1,colorScale:Qa.weight,x:o+i+Za+s+3,y:ll.top+10*il+il+10*Za});let W=ol.append("g").attr("class","intermediate-layer-annotation").style("opacity",0),K=W.append("g").attr("class","plus-annotation"),Y=h,U=gl[t][a].y+Za+3*al,J=gl[t][a].y+Za+2*al,Q=gl[t][a].y+Za/2+tl;9==a&&(U-=110,J-=70,Q-=18);let Z=K.append("text").attr("x",Y).attr("y",U).attr("class","annotation-text").style("dominant-baseline","hanging").style("text-anchor","middle");Z.append("tspan").style("dominant-baseline","hanging").text("Add up all products"),Z.append("tspan").attr("x",Y).attr("dy","1em").style("dominant-baseline","hanging").text("("),Z.append("tspan").style("fill","#66a3c8").style("dominant-baseline","hanging").text("element"),Z.append("tspan").style("dominant-baseline","hanging").text(" × "),Z.append("tspan").style("dominant-baseline","hanging").style("fill","#b58946").text("weight"),Z.append("tspan").style("dominant-baseline","hanging").text(")"),Z.append("tspan").attr("x",Y).attr("dy","1em").style("dominant-baseline","hanging").text("and then "),Z.append("tspan").style("dominant-baseline","hanging").style("fill","#479d94").text("bias"),ya({group:K,sx:h-2*tl-3,sy:J,tx:h-5,ty:Q,dr:30,hFlip:9===a,marker:"marker-alt"});let tt=gl[t][a].y;tt-=2*al+4,v.append("text").attr("class","annotation-text").attr("x",h+tl).attr("y",tt).style("text-anchor","middle").style("dominant-baseline","baseline").text("Bias");let et=W.append("g").attr("class","softmax-annotation");et.append("text").attr("x",P+27.5).attr("y",O).attr("class","annotation-text").style("dominant-baseline","baseline").style("text-anchor","middle").style("font-weight",700).text("Click ").append("tspan").attr("dx",1).style("font-weight",400).text("to learn more"),ya({group:et,sx:P+27.5-5,sy:O+4,tx:P+27.5,ty:_-tl-4,dr:50,hFlip:!0});let at=W.append("g").attr("class","flatten-annotation");Y=o-80,U=gl[t-1][0].y;let lt=at.append("text").attr("x",Y).attr("y",U).attr("class","annotation-text").style("dominant-baseline","hanging").style("text-anchor","middle");lt.append("tspan").style("dominant-baseline","hanging").style("font-weight",700).text("Hover over ").append("tspan").attr("dx",1).style("font-weight",400).style("dominant-baseline","hanging").text("matrix to"),lt.append("tspan").style("dominant-baseline","hanging").attr("x",Y).attr("dy","1em").text("see how it is flattened"),lt.append("tspan").style("dominant-baseline","hanging").attr("x",Y).attr("dy","1em").text("into a 1D array!"),ya({group:at,sx:Y+45,sy:U+.4*Za+12,tx:o-10,ty:U+Za/2,dr:80,hFlip:!0}),U=gl[t-1][1].y;let nt=at.append("text").attr("x",Y).attr("y",U).attr("class","annotation-text").style("dominant-baseline","hanging").style("text-anchor","middle");nt.append("tspan").style("dominant-baseline","hanging").text("Same flattening"),nt.append("tspan").style("dominant-baseline","hanging").attr("x",Y).attr("dy","1em").text("operation for"),nt.append("tspan").style("dominant-baseline","hanging").attr("x",Y).attr("dy","1em").text("each neuron"),ya({group:at,sx:Y+39,sy:U+25,tx:o-10,ty:U+Za/2-2,dr:80,hFlip:!0,marker:"marker-alt"}),W.append("g").attr("class","output-annotation").append("text").attr("x",gl[$l][a].x).attr("y",gl[$l][a].y+10).attr("class","annotation-text").text(`(${d3.format(".4f")(cl[$l][a].output)})`),ol.selectAll("g.intermediate-layer, g.intermediate-layer-annotation").transition().delay(500).duration(500).ease(d3.easeCubicInOut).style("opacity",1)};function _l(t,e,a){const l=t.slice();return l[82]=e[a],l[84]=a,l}function Nl(t){let e,a,l,s,r,o,u,y,x;return{c(){e=p("div"),a=p("img"),o=h(),i(a.src,l="/cnn-vis/assets/img/"+t[82].file)||f(a,"src",l),f(a,"alt","image option"),f(a,"title",s=t[82].class),f(a,"data-imagename",r=t[82].file),f(a,"class","svelte-1xz6y1p"),f(e,"class","image-container svelte-1xz6y1p"),f(e,"data-imagename",u=t[82].file),w(e,"inactive",t[7]!==t[82].file),w(e,"disabled",t[6])},m(l,s){c(l,e,s),d(e,a),d(e,o),y||(x=m(e,"click",(function(){n(t[6]?Xl:t[16])&&(t[6]?Xl:t[16]).apply(this,arguments)})),y=!0)},p(a,l){t=a,16512&l[0]&&w(e,"inactive",t[7]!==t[82].file),64&l[0]&&w(e,"disabled",t[6])},d(t){t&&g(e),y=!1,x()}}}function Hl(t){let e,a;return e=new he({props:{logits:t[3].logits,logitColors:t[3].logitColors,selectedI:t[3].selectedI,highlightI:t[3].highlightI,outputName:t[3].outputName,outputValue:t[3].outputValue,startAnimation:t[3].startAnimation}}),e.$on("xClicked",t[23]),e.$on("mouseOver",El),e.$on("mouseLeave",Rl),{c(){V(e.$$.fragment)},m(t,l){D(e,t,l),a=!0},p(t,a){const l={};8&a[0]&&(l.logits=t[3].logits),8&a[0]&&(l.logitColors=t[3].logitColors),8&a[0]&&(l.selectedI=t[3].selectedI),8&a[0]&&(l.highlightI=t[3].highlightI),8&a[0]&&(l.outputName=t[3].outputName),8&a[0]&&(l.outputValue=t[3].outputValue),8&a[0]&&(l.startAnimation=t[3].startAnimation),e.$set(l)},i(t){a||(q(e.$$.fragment,t),a=!0)},o(t){j(e.$$.fragment,t),a=!1},d(t){W(e,t)}}}function zl(t){let e,a;return e=new ce({props:{input:t[8][0].input,kernelLength:2,dataRange:t[8].colorRange,isExited:t[10]}}),e.$on("message",t[21]),{c(){V(e.$$.fragment)},m(t,l){D(e,t,l),a=!0},p(t,a){const l={};256&a[0]&&(l.input=t[8][0].input),256&a[0]&&(l.dataRange=t[8].colorRange),1024&a[0]&&(l.isExited=t[10]),e.$set(l)},i(t){a||(q(e.$$.fragment,t),a=!0)},o(t){j(e.$$.fragment,t),a=!1},d(t){W(e,t)}}}function Pl(t){let e,a;return e=new te({props:{input:t[8][0].input,output:t[8][0].output,dataRange:t[8].colorRange,isExited:t[10]}}),e.$on("message",t[22]),{c(){V(e.$$.fragment)},m(t,l){D(e,t,l),a=!0},p(t,a){const l={};256&a[0]&&(l.input=t[8][0].input),256&a[0]&&(l.output=t[8][0].output),256&a[0]&&(l.dataRange=t[8].colorRange),1024&a[0]&&(l.isExited=t[10]),e.$set(l)},i(t){a||(q(e.$$.fragment,t),a=!0)},o(t){j(e.$$.fragment,t),a=!1},d(t){W(e,t)}}}function Bl(t){let e,a;return e=new Dt({props:{input:t[8][t[9]].input,kernel:t[8][t[9]].kernel,dataRange:t[8].colorRange,colorScale:t[8].inputIsInputLayer?t[13].input[0]:t[13].conv,isInputInputLayer:t[8].inputIsInputLayer,isExited:t[11]}}),e.$on("message",t[20]),{c(){V(e.$$.fragment)},m(t,l){D(e,t,l),a=!0},p(t,a){const l={};768&a[0]&&(l.input=t[8][t[9]].input),768&a[0]&&(l.kernel=t[8][t[9]].kernel),256&a[0]&&(l.dataRange=t[8].colorRange),256&a[0]&&(l.colorScale=t[8].inputIsInputLayer?t[13].input[0]:t[13].conv),256&a[0]&&(l.isInputInputLayer=t[8].inputIsInputLayer),2048&a[0]&&(l.isExited=t[11]),e.$set(l)},i(t){a||(q(e.$$.fragment,t),a=!0)},o(t){j(e.$$.fragment,t),a=!1},d(t){W(e,t)}}}function Ol(t){let e,a,s,r,o,y,v,k,I,L,M,A,E,R,C,S,_,N,z,P,B,O,X,G,K,Y,U,J,Q,Z,tt,et,at,lt,nt,st,rt,ot,it,dt,ct,gt,pt=t[4].text+"",ut=t[14],ht=[];for(let e=0;e<ut.length;e+=1)ht[e]=Nl(_l(t,ut,e));const yt=[Bl,Pl,zl,Hl],mt=[];function ft(t,e){return t[5].data&&"conv"===t[5].data.type&&-1!=t[9]?0:t[5].data&&"relu"===t[5].data.type?1:t[5].data&&"pool"===t[5].data.type?2:t[3].show?3:-1}return~(st=ft(t))&&(rt=mt[st]=yt[st](t)),it=new fe({}),it.$on("xClicked",t[18]),it.$on("urlTyped",t[19]),{c(){e=p("div"),a=p("div"),s=p("div");for(let t=0;t<ht.length;t+=1)ht[t].c();r=h(),o=p("div"),y=p("img"),k=h(),I=p("span"),I.innerHTML='<i class="fas fa-circle fa-stack-2x"></i> \n            <i class="fas fa-pen fa-stack-1x fa-inverse"></i>',M=h(),A=p("button"),E=p("span"),E.innerHTML='<i class="fas fa-crosshairs "></i>',R=h(),C=p("span"),S=u(pt),_=h(),N=p("div"),z=p("button"),P=p("span"),P.innerHTML='<i class="fas fa-eye"></i>',B=h(),O=p("span"),O.textContent="Show detail",X=h(),G=p("div"),K=p("span"),K.innerHTML='<i class="fas fa-palette"></i>',Y=h(),U=p("div"),J=p("select"),Q=p("option"),Q.textContent="Unit",Z=p("option"),Z.textContent="Module",tt=p("option"),tt.textContent="Global",et=h(),at=p("div"),at.innerHTML='<svg id="cnn-svg" class="svelte-1xz6y1p"></svg>',lt=h(),nt=p("div"),rt&&rt.c(),ot=h(),V(it.$$.fragment),f(y,"class","custom-image svelte-1xz6y1p"),i(y.src,v="/cnn-vis/assets/img/plus.svg")||f(y,"src","/cnn-vis/assets/img/plus.svg"),f(y,"alt","plus button"),f(y,"title","Add new input image"),f(y,"data-imagename","custom"),f(I,"class","fa-stack edit-icon svelte-1xz6y1p"),w(I,"hidden",null===t[12]),f(o,"class","image-container svelte-1xz6y1p"),f(o,"data-imagename",L="custom"),w(o,"inactive","custom"!==t[7]),w(o,"disabled",t[6]),f(E,"class","icon"),b(E,"margin-right","5px"),f(C,"id","hover-label-text"),f(A,"class","button is-very-small is-link is-light svelte-1xz6y1p"),f(A,"id","hover-label"),b(A,"opacity",t[4].show?1:0),f(s,"class","left-control svelte-1xz6y1p"),f(P,"class","icon"),f(O,"id","hover-label-text"),f(z,"class","button is-very-small svelte-1xz6y1p"),f(z,"id","detailed-button"),z.disabled=t[6],w(z,"is-activated",t[2]),f(K,"class","icon is-left"),Q.__value="local",Q.value=Q.__value,Z.__value="module",Z.value=Z.__value,tt.__value="global",tt.value=tt.__value,f(J,"id","level-select"),J.disabled=t[6],f(J,"class","svelte-1xz6y1p"),void 0===t[0]&&H(()=>t[24].call(J)),f(U,"class","select svelte-1xz6y1p"),f(G,"class","control is-very-small has-icons-left svelte-1xz6y1p"),f(G,"title","Change color scale range"),f(N,"class","right-control svelte-1xz6y1p"),f(a,"class","control-container svelte-1xz6y1p"),f(at,"class","cnn svelte-1xz6y1p"),f(e,"class","overview svelte-1xz6y1p"),f(nt,"id","detailview")},m(l,i){c(l,e,i),d(e,a),d(a,s);for(let t=0;t<ht.length;t+=1)ht[t].m(s,null);d(s,r),d(s,o),d(o,y),d(o,k),d(o,I),d(s,M),d(s,A),d(A,E),d(A,R),d(A,C),d(C,S),d(a,_),d(a,N),d(N,z),d(z,P),d(z,B),d(z,O),d(N,X),d(N,G),d(G,K),d(G,Y),d(G,U),d(U,J),d(J,Q),d(J,Z),d(J,tt),$(J,t[0]),d(e,et),d(e,at),t[25](e),c(l,lt,i),c(l,nt,i),~st&&mt[st].m(nt,null),c(l,ot,i),D(it,l,i),dt=!0,ct||(gt=[m(o,"click",(function(){n(t[6]?Gl:t[17])&&(t[6]?Gl:t[17]).apply(this,arguments)})),m(z,"click",t[15]),m(J,"change",t[24])],ct=!0)},p(e,a){if(t=e,82112&a[0]){let e;for(ut=t[14],e=0;e<ut.length;e+=1){const l=_l(t,ut,e);ht[e]?ht[e].p(l,a):(ht[e]=Nl(l),ht[e].c(),ht[e].m(s,r))}for(;e<ht.length;e+=1)ht[e].d(1);ht.length=ut.length}(!dt||4096&a[0])&&w(I,"hidden",null===t[12]),(!dt||128&a[0])&&w(o,"inactive","custom"!==t[7]),(!dt||64&a[0])&&w(o,"disabled",t[6]),(!dt||16&a[0])&&pt!==(pt=t[4].text+"")&&x(S,pt),(!dt||16&a[0])&&b(A,"opacity",t[4].show?1:0),(!dt||64&a[0])&&(z.disabled=t[6]),(!dt||4&a[0])&&w(z,"is-activated",t[2]),(!dt||64&a[0])&&(J.disabled=t[6]),1&a[0]&&$(J,t[0]);let l=st;st=ft(t),st===l?~st&&mt[st].p(t,a):(rt&&(F(),j(mt[l],1,1,()=>{mt[l]=null}),T()),~st?(rt=mt[st],rt?rt.p(t,a):(rt=mt[st]=yt[st](t),rt.c()),q(rt,1),rt.m(nt,null)):rt=null)},i(t){dt||(q(rt),q(it.$$.fragment,t),dt=!0)},o(t){j(rt),j(it.$$.fragment,t),dt=!1},d(a){a&&g(e),function(t,e){for(let a=0;a<t.length;a+=1)t[a]&&t[a].d(e)}(ht,a),t[25](null),a&&g(lt),a&&g(nt),~st&&mt[st].d(),a&&g(ot),W(it,a),ct=!1,l(gt)}}}const Xl=()=>{},Gl=()=>{};function Fl(t,e,a){let l,n=new Set(["local","module","global"]),s="local";nt.set(s);let r=s,o=void 0,i=void 0;const d=Re.layerColorScales,c=Re.nodeLength,g=Re.numLayers,p=Re.edgeOpacity,u=Re.edgeInitColor,h=Re.edgeHoverColor,y=Re.edgeStrokeWidth,m=Re.svgPaddings,f=Re.overlayRectOffset;let x=[void 0,void 0];ot.subscribe(t=>{x=t});let v=void 0;lt.subscribe(t=>{v=t});let b=void 0;st.subscribe(t=>{b=t}),rt.subscribe(t=>{});let $=void 0;it.subscribe(t=>{a(2,$=t)}),dt.subscribe(t=>{}),et.subscribe(t=>{});let w=void 0;at.subscribe(t=>{w=t});let k=void 0;ct.subscribe(t=>{k=t});let I=void 0;gt.subscribe(t=>{a(3,I=t)});let M=void 0;ht.subscribe(t=>{M=t});let A=void 0;ut.subscribe(t=>{a(4,A=t)});let E=void 0;yt.subscribe(t=>{E=t});let C=void 0,S=void 0,_=void 0,N={layerName:"",index:-1,data:null},H=!1,z=!1,P=-1,B=-1,O=void 0,X=!1,G=void 0;const F={input:0,conv_1_1:1,relu_1_1:2,conv_1_2:3,relu_1_2:4,max_pool_1:5,conv_2_1:6,relu_2_1:7,conv_2_2:8,relu_2_2:9,max_pool_2:10,output:11},T={0:{local:"input-legend",module:"input-legend",global:"input-legend"},1:{local:"local-legend-0-1",module:"module-legend-0",global:"global-legend"},2:{local:"local-legend-0-1",module:"module-legend-0",global:"global-legend"},3:{local:"local-legend-0-2",module:"module-legend-0",global:"global-legend"},4:{local:"local-legend-0-2",module:"module-legend-0",global:"global-legend"},5:{local:"local-legend-0-2",module:"module-legend-0",global:"global-legend"},6:{local:"local-legend-1-1",module:"module-legend-1",global:"global-legend"},7:{local:"local-legend-1-1",module:"module-legend-1",global:"global-legend"},8:{local:"local-legend-1-2",module:"module-legend-1",global:"global-legend"},9:{local:"local-legend-1-2",module:"module-legend-1",global:"global-legend"},10:{local:"local-legend-1-2",module:"module-legend-1",global:"global-legend"},11:{local:"output-legend",module:"output-legend",global:"output-legend"}};let q,j=[{file:"boat_1.jpeg",class:"lifeboat"},{file:"bug_1.jpeg",class:"ladybug"},{file:"pizza_1.jpeg",class:"pizza"},{file:"pepper_1.jpeg",class:"bell pepper"},{file:"bus_1.jpeg",class:"bus"},{file:"koala_1.jpeg",class:"koala"},{file:"espresso_1.jpeg",class:"espresso"},{file:"panda_1.jpeg",class:"red panda"},{file:"orange_1.jpeg",class:"orange"},{file:"car_1.jpeg",class:"sport car"}],V=j[6].file,D=-1,W=!0,K=!0,Y=null;const U=(t,e,a)=>{void 0===O&&i.select("rect#underneath-gateway-"+t.index).style("opacity",1)},J=(t,e,a)=>{void 0===O&&i.select("rect#underneath-gateway-"+t.index).style("opacity",0)},Q=(t,e,l,n,r)=>{if(d3.event.stopPropagation(),a(11,K=!1),O===t.index)a(9,D=-1),O=void 0,i.select("rect#underneath-gateway-"+t.index).style("opacity",0);else{a(9,D=t.index);t.output,t.outputLinks[n].weight;let e=b[s][r-1],l=b[s][r],o=Math.max(e,l);void 0!==O&&(i.select("rect#underneath-gateway-"+O).style("opacity",0),i.select("rect#underneath-gateway-"+t.index).style("opacity",1));let d=d3.select("#cnn-svg"),c=+d.style("height").replace("px","")/2,g=+d.style("width").replace("px",""),p=100+c-125,u=E[Object.keys(F)[r]],h=0;r>6?(h=(u-m.left)/2,h=m.left+h-243):(h=(g+m.right-u)/2,h=u+h-243);const y=document.getElementById("detailview");y.style.top=p+"px",y.style.left=h+"px",y.style.position="absolute",O=t.index,a(8,q.colorRange=o,q),a(8,q.inputIsInputLayer=r<=1,q)}},mt=()=>{if(void 0!==O)a(9,D=-1),i.select("rect#underneath-gateway-"+O).style("opacity",0),O=void 0;else if(k)i.select(".softmax-symbol").dispatch("click");else if(H){let t=F[N.layerName];$t(t,N.domG,N.domI),d3.select(N.domG[N.domI]).dispatch("mouseleave")}else z&&ft()},ft=()=>{z=!1,P=-1;let t=F[N.layerName],e=N.index;i.select(`g#layer-${t}-node-${e}`).select("rect.bounding").classed("hidden",!0),N.data.inputLinks.forEach(t=>{let e=F[t.source.layerName],a=t.source.index;i.select(`g#layer-${e}-node-${a}`).select("rect.bounding").classed("hidden",!0)}),i.select("g.underneath").selectAll("rect").remove();i.select("g.edge-group").selectAll(".edge").filter(t=>t.targetLayerIndex!==B).style("visibility",null);a(6,X=!1),i.selectAll(`.${s}-legend`).classed("hidden",!$),i.selectAll(".input-legend").classed("hidden",!$),i.selectAll(".output-legend").classed("hidden",!$),i.select("g.cnn-group").select("g.edge-group").selectAll(`path.edge-${t}-${e}`).transition().ease(d3.easeCubicOut).duration(200).style("stroke",u).style("stroke-width",y).style("opacity",p),i.selectAll("g.intermediate-layer-overlay, g.intermediate-layer-annotation").transition("remove").duration(500).ease(d3.easeCubicInOut).style("opacity",0).on("end",(t,e,a)=>{i.selectAll("g.intermediate-layer-overlay, g.intermediate-layer-annotation").remove(),i.selectAll("defs.overlay-gradient").remove(),i.select(".input-annotation").classed("hidden",!1)}),i.select("g#cnn-layer-group-"+t).selectAll("g.node-group").each((t,e,a)=>{d3.select(a[e]).style("pointer-events","all")}),i.select("g#cnn-layer-group-"+(t-1)).selectAll("g.node-group").each((t,e,a)=>{d3.select(a[e]).style("pointer-events","all").on("mouseover",kt).on("mouseleave",It).on("click",wt)}),a(5,N.layerName="",N),a(5,N.index=-1,N),a(5,N.data=null,N),B=-1},xt=(t,e,a)=>{let l=F[t.layerName],n=t.index;i.select("g.cnn-group").select("g.edge-group").selectAll(`path.edge-${B}-${n}`).raise().transition().ease(d3.easeCubicInOut).duration(400).style("stroke",h).style("stroke-width","1").style("opacity",1),d3.select(a[e]).select("rect.bounding").classed("hidden",!1);let s=l-1;l===B-1&&(s=l+1),i.select(`g#layer-${s}-node-${n}`).select("rect.bounding").classed("hidden",!1)},vt=(t,e,a)=>{let l=F[t.layerName],n=t.index;i.select("g.cnn-group").select("g.edge-group").selectAll(`path.edge-${B}-${n}`).transition().ease(d3.easeCubicOut).duration(200).style("stroke",u).style("stroke-width",y).style("opacity",p),d3.select(a[e]).select("rect.bounding").classed("hidden",!0);let s=l-1;l===B-1&&(s=l+1),i.select(`g#layer-${s}-node-${n}`).select("rect.bounding").classed("hidden",!0)},bt=(t,e,a)=>{let l=F[t.layerName],n=t.index;i.select(`g#layer-${l+1}-node-${n}`).node().dispatchEvent(new Event("click"))},$t=(t,e,l)=>{k&&(i.select(".logit-layer").remove(),i.select(".logit-layer-lower").remove(),i.selectAll(".plus-symbol-clone").remove(),i.select(".underneath").selectAll(".logit-lower").style("opacity",0),gt.set({show:!1,logits:[]}),pt.set(!1)),ct.set(!1),H=!1,i.selectAll(`.${s}-legend`).classed("hidden",!$),i.selectAll(".input-legend").classed("hidden",!$),i.selectAll(".output-legend").classed("hidden",!$),a(6,X=!1);for(let e=0;e<G[t-1].length;e++)i.select(`g#layer-${t-1}-node-${e}`).on("mouseover",kt).on("mouseleave",It).on("click",wt);i.select("g.underneath").selectAll("rect").remove(),O=void 0,i.select("g#cnn-layer-group-"+(t-1)).selectAll("rect.bounding").style("stroke-width",1),d3.select(e[l]).select("rect.bounding").style("stroke-width",1),i.selectAll(`g#layer-label-${t-1},\n      g#layer-detailed-label-${t-1},\n      g#layer-label-${t},\n      g#layer-detailed-label-${t}`).style("font-weight","normal"),a(5,N.layerName="",N),a(5,N.index=-1,N),a(5,N.data=null,N),a(11,K=!0);let n=i.select("g.intermediate-layer");if(dt.set(!1),n.transition("remove").duration(500).ease(d3.easeCubicInOut).style("opacity",0).on("end",(t,e,a)=>{d3.select(a[e]).remove()}),i.selectAll(".overlay-group").remove(),i.selectAll("g.intermediate-layer-overlay, g.intermediate-layer-annotation").transition("remove").duration(500).ease(d3.easeCubicInOut).style("opacity",0).on("end",(t,e,a)=>{i.selectAll("g.intermediate-layer-overlay, g.intermediate-layer-annotation").remove(),i.selectAll("defs.overlay-gradient").remove()}),void 0!==x[0]){let t=b[s][x[0]];void 0!==x[1]?i.select(`g#layer-${x[0]}-node-${x[1]}`).select("image.node-image").each((e,a,l)=>ta(e,a,l,t)):i.select("g#cnn-layer-group-"+x[0]).selectAll("image.node-image").each((e,a,l)=>ta(e,a,l,t))}for(let t=0;t<g;t++)pa({layerIndex:t,targetX:v[t][0].x,disable:!1,delay:500,opacity:1});pa({layerIndex:g-2,targetX:v[g-2][0].x,opacity:1,disable:!1,delay:500,onEndFunc:()=>{i.select("g.edge-group").style("visibility","visible"),i.select(".input-annotation").classed("hidden",!1)}})},wt=(t,e,l)=>{d3.event.stopPropagation();let n=t.index;if(a(5,N.layerName=t.layerName,N),a(5,N.index=t.index,N),a(5,N.data=t,N),a(5,N.domI=e,N),a(5,N.domG=l,N),"conv"===t.type||"relu"===t.type||"pool"===t.type){let e=[];for(let a=0;a<t.inputLinks.length;a++)e.push({input:t.inputLinks[a].source.output,kernel:t.inputLinks[a].weight,output:t.inputLinks[a].dest.output});let l=F[t.layerName];e.colorRange=b[s][l],e.isInputInputLayer=l<=1,a(8,q=e)}let r=F[t.layerName];if("relu"==t.type||"pool"==t.type)if(a(10,W=!1),z)if(t.index===P)ft();else{i.select(`g#layer-${r}-node-${P}`).select("rect.bounding").classed("hidden",!0),i.select(`g#layer-${r-1}-node-${P}`).select("rect.bounding").classed("hidden",!0);let t=i.select("g.cnn-group").select("g.edge-group");t.selectAll(`path.edge-${r}-${P}`).transition().ease(d3.easeCubicOut).duration(200).style("stroke",u).style("stroke-width",y).style("opacity",p);let e=i.select("g.underneath");e.select("#underneath-gateway-"+P).style("opacity",0),i.select(`g#layer-${r}-node-${n}`).select("rect.bounding").classed("hidden",!1),i.select(`g#layer-${r-1}-node-${n}`).select("rect.bounding").classed("hidden",!1),t.selectAll(`path.edge-${r}-${n}`).raise().transition().ease(d3.easeCubicInOut).duration(400).style("stroke",h).style("stroke-width","1").style("opacity",1),e.select("#underneath-gateway-"+n).style("opacity",1),P=n}else((t,e)=>{z=!0,P=e,B=t;let l=d3.select("#cnn-svg"),n=+l.style("height").replace("px","")/2,r=+l.style("width").replace("px",""),o=100+n-130,d=0;t>5?(d=v[t-1][0].x+50,d=d/2-250):(d=(r-v[t][0].x-c)/2,d=v[t][0].x+c+d-250);const g=document.getElementById("detailview");g.style.top=o+"px",g.style.left=d+"px",g.style.position="absolute";i.select("g.edge-group").selectAll(".edge").filter(e=>e.targetLayerIndex!==t).style("visibility","hidden");a(6,X=!0),i.select(".input-annotation").classed("hidden",!0),i.selectAll(`.${s}-legend`).classed("hidden",!0),i.selectAll(".input-legend").classed("hidden",!0),i.selectAll(".output-legend").classed("hidden",!0),i.select("#"+T[t][s]).classed("hidden",!1);let p=v[t-1][e].x,u=v[t][e].x+c+5,h=C-u-f/2,y=p-v[0][0].x;if(h>y){let t=[{offset:"0%",color:"rgb(250, 250, 250)",opacity:.85},{offset:"50%",color:"rgb(250, 250, 250)",opacity:.9},{offset:"100%",color:"rgb(250, 250, 250)",opacity:1}];ua("overlay-gradient-right",t),t=[{offset:"0%",color:"rgb(250, 250, 250)",opacity:.85+y/h*(.95-.85)},{offset:"100%",color:"rgb(250, 250, 250)",opacity:.85}],ua("overlay-gradient-left",t)}else{let t=[{offset:"0%",color:"rgb(250, 250, 250)",opacity:1},{offset:"50%",color:"rgb(250, 250, 250)",opacity:.9},{offset:"100%",color:"rgb(250, 250, 250)",opacity:.85}];ua("overlay-gradient-left",t),t=[{offset:"0%",color:"rgb(250, 250, 250)",opacity:.85},{offset:"100%",color:"rgb(250, 250, 250)",opacity:.85+h/y*(.95-.85)}],ua("overlay-gradient-right",t)}Da("overlay-gradient-right",u+f/2+.5,0,h,S+m.top),Da("overlay-gradient-left",v[0][0].x-f/2,0,y,S+m.top),i.selectAll("rect.overlay").on("click",mt);let x=i.select("g.underneath");for(let e=0;e<G[t-1].length;e++)x.append("rect").attr("class","underneath-gateway").attr("id","underneath-gateway-"+e).attr("x",v[t-1][e].x-7).attr("y",v[t-1][e].y-7).attr("width",2*c+w+14).attr("height",c+14).attr("rx",10).style("fill","rgba(160, 160, 160, 0.3)").style("opacity",0),i.select(`g#layer-${t-1}-node-${e}`).style("pointer-events","all").style("cursor","pointer").on("mouseover",xt).on("mouseleave",vt).on("click",bt);x.lower(),x.select("#underneath-gateway-"+e).style("opacity",1)})(r,t.index);"conv"!==t.type&&"output"!==t.layerName||H?"conv"!==t.type&&"output"!==t.layerName||!H||$t(r,l,e):(((t,e,l,n)=>{H=!0,i.selectAll(`.${s}-legend`).classed("hidden",!0),i.selectAll(".input-legend").classed("hidden",!0),i.selectAll(".output-legend").classed("hidden",!0),i.select(".input-annotation").classed("hidden",!0),i.select("g#cnn-layer-group-"+(n-1)).selectAll("rect.bounding").style("stroke-width",2),d3.select(e[l]).select("rect.bounding").style("stroke-width",2),a(6,X=!0),dt.set(!0),i.selectAll(`g#layer-label-${n-1},\n      g#layer-detailed-label-${n-1},\n      g#layer-label-${n},\n      g#layer-detailed-label-${n}`).style("font-weight","800"),d3.select("#cnn-svg").on("click",mt)})(0,l,n,r),"conv_1_1"===t.layerName?Ka(r,t,n,C,S,U,J,Q):"conv_1_2"===t.layerName?Ya(r,t,n,C,S,U,J,Q):"conv_2_1"===t.layerName?Ua(r,t,n,C,S,U,J,Q):"conv_2_2"===t.layerName?Ja(r,t,n,C,S,U,J,Q):"output"===t.layerName&&Sl(r,t,n,0,S))},kt=(t,e,a)=>{if(H)return;let l=F[t.layerName],n=t.index;if(i.select("g.cnn-group").select("g.edge-group").selectAll(`path.edge-${l}-${n}`).raise().transition().ease(d3.easeCubicInOut).duration(400).style("stroke",h).style("stroke-width","1").style("opacity",1),d3.select(a[e]).select("rect.bounding").classed("hidden",!1),1===t.inputLinks.length){let e=t.inputLinks[0],a=F[e.source.layerName],l=e.source.index;i.select(`g#layer-${a}-node-${l}`).select("rect.bounding").classed("hidden",!1)}else i.select("g#cnn-layer-group-"+(l-1)).selectAll("g.node-group").selectAll("rect.bounding").classed("hidden",!1);"output"===t.layerName&&d3.select(a[e]).select(".output-text").style("opacity",.8).style("text-decoration","underline")},It=(t,e,a)=>{if(!H&&(z||t.layerName!==N.layerName||t.index!==N.index)){let l=F[t.layerName],n=t.index;if(i.select("g.cnn-group").select("g.edge-group").selectAll(`path.edge-${l}-${n}`).transition().ease(d3.easeCubicOut).duration(200).style("stroke",u).style("stroke-width",y).style("opacity",p),d3.select(a[e]).select("rect.bounding").classed("hidden",!0),1===t.inputLinks.length){let e=t.inputLinks[0],a=F[e.source.layerName],l=e.source.index;i.select(`g#layer-${a}-node-${l}`).select("rect.bounding").classed("hidden",!0)}else i.select("g#cnn-layer-group-"+(l-1)).selectAll("g.node-group").selectAll("rect.bounding").classed("hidden",t=>t.layerName!==N.layerName||t.index!==N.index);"output"===t.layerName&&d3.select(a[e]).select(".output-text").style("fill","black").style("opacity",.5).style("text-decoration","none")}};L(async()=>{o=d3.select(l).select("#cnn-svg"),i=o.append("g").attr("class","main-svg").attr("transform",`translate(${m.left}, 0)`),tt.set(i),C=Number(o.style("width").replace("px",""))-m.left-m.right,S=Number(o.style("height").replace("px",""))-m.top-m.bottom;let t=i.append("g").attr("class","cnn-group");i.append("g").attr("class","underneath"),o.style("height").replace("px","");var e;i.append("defs").append("marker").attr("id","marker").attr("viewBox","0 -5 10 10").attr("refX",6).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").style("stroke-width",1.2).style("fill","gray").style("stroke","gray").attr("d","M0,-5L10,0L0,5"),i.append("defs").append("marker").attr("id","marker-alt").attr("viewBox","0 -5 10 10").attr("refX",6).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").style("fill","none").style("stroke","gray").style("stroke-width",2).attr("d","M-5,-10L10,0L-5,10"),console.time("Construct cnn"),_=await(e="/cnn-vis/assets/data/model.json",tf.loadLayersModel(e)),G=await Me("/cnn-vis/assets/img/"+V,_),console.timeEnd("Construct cnn"),Z.set(G);let a=G[G.length-2];G.splice(G.length-2,1),G.flatten=a,console.log(G),sa(),la(C,S,t,kt,It,wt)});const Lt=async t=>{a(12,Y=t.detail.url),G=await Me(Y,_);let e=G[G.length-2];G.splice(G.length-2,1),G.flatten=e,Z.set(G),((t,e)=>{let a=t.width,l=e[0].output.length,n=document.createElement("canvas"),s=n.getContext("2d");n.width=l,n.height=l;let r=s.getImageData(0,0,l,l),o=r.data;for(let t=0;t<o.length;t+=4){let a=Math.floor(t/4),n=Math.floor(a/l),s=a%l,r=e[0].output[n][s],i=e[1].output[n][s],d=e[2].output[n][s];o[t]=255*r,o[t+1]=255*i,o[t+2]=255*d,o[t+3]=255}let i=document.createElement("canvas");i.width=3*a,i.height=3*a;let d=i.getContext("2d");s.putImageData(r,0,0),d.drawImage(n,0,0,l,l,0,0,3*a,3*a);let c=i.toDataURL();t.src=c,n.remove(),i.remove()})(d3.select(l).select(".custom-image").node(),G[0]),sa(),na()};return t.$$.update=()=>{1&t.$$.dirty[0]&&(()=>{if(void 0!==i){if(n.add(s)||console.error("Encounter unknown scale level!"),s!=r){({local:{module:[1,2,8,9,10],global:[1,2,3,4,5,8,9,10]},module:{local:[1,2,8,9,10],global:[1,2,3,4,5,8,9,10]},global:{local:[1,2,3,4,5,8,9,10],module:[1,2,3,4,5]}})[r][s].forEach(t=>{let e=b[s][t];i.select("#cnn-layer-group-"+t).selectAll(".node-image").each((t,a,l)=>ta(t,a,l,e))}),i.selectAll(`.${r}-legend`).classed("hidden",!0),i.selectAll(`.${s}-legend`).classed("hidden",!$)}r=s,nt.set(s)}})()},[s,l,$,I,A,N,X,V,q,D,W,K,Y,d,j,()=>{a(2,$=!$),it.set($),H||(i.selectAll(`.${s}-legend`).classed("hidden",!$),i.selectAll(".input-legend").classed("hidden",!$),i.selectAll(".output-legend").classed("hidden",!$)),i.selectAll(".layer-detailed-label").classed("hidden",!$),i.selectAll(".layer-label").classed("hidden",$)},async t=>{let e=d3.select(t.target).attr("data-imageName");if(e!==V){a(7,V=e),G=await Me("/cnn-vis/assets/img/"+V,_);let t=G[G.length-2];G.splice(G.length-2,1),G.flatten=t,Z.set(G),sa(),na()}},()=>{if(null===Y)M.show=!0,M.preImage=V,ht.set(M);else if("custom"!==V){Lt({detail:{url:Y}})}else M.show=!0,M.preImage=V,ht.set(M);"custom"!==V&&a(7,V="custom")},t=>{a(7,V=t.detail.preImage)},Lt,function(t){t.detail.text&&(O=void 0,i.select("rect#underneath-gateway-"+D).style("opacity",0),a(9,D=-1))},function(t){t.detail.text&&(ft(),a(10,W=!0))},function(t){t.detail.text&&(ft(),a(10,W=!0))},function(t){a(3,I.show=!1,I),gt.set(I)},function(){s=function(t){const e=t.querySelector(":checked")||t.options[0];return e&&e.__value}(this),a(0,s)},function(t){R[t?"unshift":"push"](()=>{l=t,a(1,l)})}]}class Tl extends U{constructor(t){super(),Y(this,t,Fl,Ol,s,{},null,[-1,-1,-1])}}function ql(e){let a,l,n;return l=new Tl({}),{c(){a=p("div"),V(l.$$.fragment),f(a,"id","explainer"),f(a,"class","svelte-1avhf6")},m(t,e){c(t,a,e),D(l,a,null),n=!0},p:t,i(t){n||(q(l.$$.fragment,t),n=!0)},o(t){j(l.$$.fragment,t),n=!1},d(t){t&&g(a),W(l)}}}function jl(t){return[]}class Vl extends U{constructor(t){super(),Y(this,t,jl,ql,s,{})}}function Dl(e){let a;return{c(){a=p("div"),a.innerHTML='<div id="logo" class="svelte-qob9ex"><div id="logo-text" class="svelte-qob9ex">CNN Explainer</div> \n\t\t<svg width="510px" height="50px"><defs><filter x="0%" y="0%" width="100%" height="100%" filterUnits="objectBoundingBox" id="chalk-texture"><feTurbulence type="fractalNoise" baseFrequency="2" numOctaves="5" stitchTiles="stitch" result="f1"></feTurbulence><feColorMatrix type="matrix" values="0 0 0 0 0, 0 0 0 0 0, 0 0 0 0 0, 0 0 0 -1.5 1.5" result="f2"></feColorMatrix><feComposite operator="in" in2="f2" in="SourceGraphic" result="f3"></feComposite></filter></defs></svg></div>',f(a,"id","header"),f(a,"class","svelte-qob9ex")},m(t,e){c(t,a,e)},p:t,i:t,o:t,d(t){t&&g(a)}}}class Wl extends U{constructor(t){super(),Y(this,t,null,Dl,s,{})}}function Kl(e){let a,l,n,s,r;return l=new Wl({}),s=new Vl({}),{c(){a=p("div"),V(l.$$.fragment),n=h(),V(s.$$.fragment),f(a,"id","app-page")},m(t,e){c(t,a,e),D(l,a,null),d(a,n),D(s,a,null),r=!0},p:t,i(t){r||(q(l.$$.fragment,t),q(s.$$.fragment,t),r=!0)},o(t){j(l.$$.fragment,t),j(s.$$.fragment,t),r=!1},d(t){t&&g(a),W(l),W(s)}}}return new class extends U{constructor(t){super(),Y(this,t,null,Kl,s,{})}}({target:document.body,props:{}})}();
//# sourceMappingURL=bundle.js.map
